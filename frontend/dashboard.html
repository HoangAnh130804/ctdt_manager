<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #1a252f 100%);
            color: white;
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
        }
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border-left: 3px solid transparent;
            transition: all 0.3s;
            text-decoration: none;
        }
        .nav-link:hover, .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
            border-left-color: #3498db;
        }
        .stat-card {
            border-radius: 10px;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .badge-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-draft { background-color: #6c757d; }
        .badge-pending { background-color: #ffc107; color: #000; }
        .badge-approved { background-color: #28a745; }
        .badge-inactive { background-color: #dc3545; }
        .action-buttons .btn {
            padding: 3px 8px;
            margin: 2px;
        }
        .dataTables_wrapper {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                transition: left 0.3s;
            }
            .sidebar.show {
                left: 0;
            }
            .main-content {
                margin-left: 0;
            }
            .mobile-toggle {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Toggle Button -->
    <button class="btn btn-primary mobile-toggle d-md-none" style="position: fixed; top: 10px; left: 10px; z-index: 1001;">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-4 text-center">
            <i class="fas fa-university fa-3x mb-3 text-primary"></i>
            <h5 id="userName">Nguyễn Văn Admin</h5>
            <small id="userRole" class="text-light">Quản trị viên</small>
            <div class="mt-3">
                <small class="text-muted">Hệ thống Quản lý Đào tạo</small>
            </div>
        </div>
        
        <nav class="nav flex-column mt-3">
            <a href="#" class="nav-link active" onclick="showDashboard()">
                <i class="fas fa-home me-2"></i>Dashboard
            </a>
            <a href="#" class="nav-link" onclick="loadCourses()">
                <i class="fas fa-graduation-cap me-2"></i>Quản lý Khóa/Hệ/Ngành
            </a>
            <a href="#" class="nav-link" onclick="loadPrograms()">
                <i class="fas fa-book me-2"></i>Quản lý CTĐT
            </a>
            <a href="#" class="nav-link" onclick="loadSubjects()">
                <i class="fas fa-book-open me-2"></i>Quản lý Môn học
            </a>
            <hr class="text-white-50 mx-3">
            <a href="#" class="nav-link" onclick="showProfile()">
                <i class="fas fa-user me-2"></i>Tài khoản
            </a>
            <a href="#" class="nav-link text-danger" onclick="logout()">
                <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
            </a>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div id="content">
            <!-- Dashboard will be loaded here -->
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Đang tải...</p>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    
    <script>
        // Global variables
        const API_BASE_URL = 'https://ctdt-manager-backend.onrender.com/api';
        let currentUser = null;
        let currentPage = 'dashboard';
        
        // Initialize
        $(document).ready(function() {
            checkAuth();
            setupEventListeners();
        });
        
        function checkAuth() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');

            if (!token || !user) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = JSON.parse(user);
            updateUserInfo();
            showDashboard();
        }
        
        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(API_BASE_URL + endpoint, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { Authorization: `Bearer ${token}` } : {})
                    }
                });
                
                if (response.status === 401) {
                    localStorage.clear();
                    window.location.href = 'index.html';
                    return null;
                }

                return await response.json();
            } catch (error) {
                console.error('API ERROR:', error);
                showToast('Lỗi kết nối server', 'danger');
                return null;
            }
        }
        
        function updateUserInfo() {
            $('#userName').text(currentUser.full_name || currentUser.username);
            $('#userRole').text(currentUser.role);
        }
        
        function setupEventListeners() {
            // Mobile menu toggle
            $('.mobile-toggle').click(function() {
                $('.sidebar').toggleClass('show');
            });
            
            // Close sidebar when clicking outside on mobile
            $(document).click(function(e) {
                if ($(window).width() < 768) {
                    if (!$(e.target).closest('.sidebar').length && 
                        !$(e.target).closest('.mobile-toggle').length) {
                        $('.sidebar').removeClass('show');
                    }
                }
            });
        }
        
        // Toast notification
        function showToast(message, type = 'info', title = 'Thông báo') {
            $('#toastMessage').text(message);
            $('#toastTitle').text(title);
            
            // Set toast background color
            const toastElement = document.getElementById('liveToast');
            toastElement.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
            
            if (type === 'success') toastElement.classList.add('bg-success', 'text-white');
            else if (type === 'danger') toastElement.classList.add('bg-danger', 'text-white');
            else if (type === 'warning') toastElement.classList.add('bg-warning');
            else toastElement.classList.add('bg-info', 'text-white');
            
            new bootstrap.Toast(toastElement).show();
        }
        
        // ==================== DASHBOARD ====================
        function showDashboard() {
            currentPage = 'dashboard';
            updateActiveMenu();
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-home me-2"></i>Dashboard</h3>
                    <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-2"></i>Làm mới
                    </button>
                </div>
                
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6">
                        <div class="stat-card bg-primary">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Tổng Khóa/Hệ/Ngành</h6>
                                    <h2 id="totalCoursesCount">0</h2>
                                </div>
                                <i class="fas fa-graduation-cap fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="stat-card bg-success">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Tổng CTĐT</h6>
                                    <h2 id="totalProgramsCount">0</h2>
                                </div>
                                <i class="fas fa-book fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="stat-card bg-warning">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">CTĐT Chờ duyệt</h6>
                                    <h2 id="pendingProgramsCount">0</h2>
                                </div>
                                <i class="fas fa-clock fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="stat-card bg-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">CTĐT Đã duyệt</h6>
                                    <h2 id="approvedProgramsCount">0</h2>
                                </div>
                                <i class="fas fa-check-circle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Thao tác nhanh</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                                    <button class="btn btn-primary" onclick="showAddCourseForm()">
                                        <i class="fas fa-plus me-2"></i>Thêm Khóa/Hệ/Ngành
                                    </button>
                                    <button class="btn btn-success" onclick="showAddProgramForm()">
                                        <i class="fas fa-plus me-2"></i>Thêm Chương trình Đào tạo
                                    </button>
                                    ` : ''}
                                    <button class="btn btn-outline-primary" onclick="loadCourses()">
                                        <i class="fas fa-list me-2"></i>Xem danh sách Khóa học
                                    </button>
                                    <button class="btn btn-outline-success" onclick="loadPrograms()">
                                        <i class="fas fa-list me-2"></i>Xem danh sách CTĐT
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Báo cáo nhanh</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-warning" onclick="exportCoursesExcel()">
                                        <i class="fas fa-file-excel me-2"></i>Xuất Excel Khóa học
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="exportProgramsExcel()">
                                        <i class="fas fa-file-excel me-2"></i>Xuất Excel CTĐT
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            loadDashboardData();
        }
        
        async function loadDashboardData() {
            const courses = await apiRequest('/courses');
            const programs = await apiRequest('/programs');
            
            if (courses?.success) {
                const courseList = courses.data || [];
                $('#totalCoursesCount').text(courseList.length);
            }
            
            if (programs?.success) {
                const list = programs.data || [];
                $('#totalProgramsCount').text(list.length);
                $('#pendingProgramsCount').text(list.filter(p => p.status === 'pending').length);
                $('#approvedProgramsCount').text(list.filter(p => p.status === 'approved').length);
            }
        }
        
        function refreshDashboard() {
            loadDashboardData();
            showToast('Đã làm mới dữ liệu', 'success');
        }
        
        // ==================== COURSE MANAGEMENT ====================
        async function loadCourses() {
            currentPage = 'courses';
            updateActiveMenu();
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-graduation-cap me-2"></i>Quản lý Ngành học</h3>
                    <div>
                        ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                        <button class="btn btn-primary me-2" onclick="showAddCourseForm()">
                            <i class="fas fa-plus me-2"></i>Thêm mới
                        </button>
                        ` : ''}
                        <button class="btn btn-warning" onclick="exportCoursesExcel()">
                            <i class="fas fa-file-excel me-2"></i>Xuất Excel
                        </button>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchCourse" placeholder="Tìm kiếm mã, tên ngành...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterCourseEducationSystem">
                                    <option value="">Tất cả hệ đào tạo</option>
                                    <option value="Đại học">Đại học</option>
                                    <option value="Cao đẳng">Cao đẳng</option>
                                    <option value="Chất lượng cao">Chất lượng cao</option>
                                    <option value="Liên thông">Liên thông</option>
                                    <option value="Vừa học vừa làm">Vừa học vừa làm</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="searchCourses()">
                                    <i class="fas fa-search me-2"></i>Tìm kiếm
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-secondary w-100" onclick="resetCourseSearch()">
                                    <i class="fas fa-redo me-2"></i>Đặt lại
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table id="coursesTable" class="table table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Mã ngành</th>
                                <th>Tên ngành</th>
                                <th>Hệ</th>
                                <th>Khóa</th>
                                <th>Thời gian</th>
                                <th>Số tín chỉ</th>
                                <th>Khoa/Phòng</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded by DataTables -->
                        </tbody>
                    </table>
                </div>
            `);
            
            initializeCoursesTable();
        }
        
        function initializeCoursesTable() {
            if ($.fn.DataTable.isDataTable('#coursesTable')) {
                $('#coursesTable').DataTable().destroy();
            }
            
            const table = $('#coursesTable').DataTable({
                processing: true,
                serverSide: false,
                ajax: {
                    url: API_BASE_URL + '/courses',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    dataSrc: 'data'
                },
                columns: [
                    { 
                        data: null,
                        render: function(data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { 
                        data: 'code',
                        render: function(data) {
                            return `<span class="badge bg-primary">${data}</span>`;
                        }
                    },
                    { data: 'name' },
                    { 
                        data: 'education_system',
                        render: function(data) {
                            return `<span class="badge bg-info">${data}</span>`;
                        }
                    },
                    { 
                        data: 'admission_year',
                        render: function(data) {
                            return `<span class="badge bg-warning">Khóa ${data}</span>`;
                        }
                    },
                    { 
                        data: 'duration',
                        render: function(data) {
                            return data + ' năm';
                        }
                    },
                    { 
                        data: 'total_credits',
                        render: function(data) {
                            return '<span class="badge bg-success">' + data + ' TC</span>';
                        }
                    },
                    { data: 'department' },
                    {
                        data: 'id',
                        render: function(data, type, row) {
                            let actions = `
                                <button class="btn btn-sm btn-info me-1" onclick="viewCourseDetail(${data})" title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </button>
                            `;
                            
                            if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                                actions += `
                                    <button class="btn btn-sm btn-warning me-1" onclick="showEditCourseForm(${data})" title="Sửa">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteCourse(${data})" title="Xóa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                `;
                            }
                            
                            return '<div class="action-buttons">' + actions + '</div>';
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json'
                },
                pageLength: 10,
                order: [[0, 'asc']]
            });
        }
        
        function showAddCourseForm() {
            const educationSystems = [
                'Đại học',
                'Cao đẳng', 
                'Chất lượng cao',
                'Liên thông',
                'Vừa học vừa làm'
            ];
            
            const currentYear = new Date().getFullYear();
            const admissionYears = [];
            for (let year = currentYear + 1; year >= currentYear - 4; year--) {
                admissionYears.push(year);
            }
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-plus-circle me-2"></i>Thêm Ngành học mới</h3>
                    <button class="btn btn-secondary" onclick="loadCourses()">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <form id="addCourseForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Mã ngành <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="courseCode" required>
                                    <div class="form-text">Mã duy nhất cho ngành học, không trùng lặp</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tên đầy đủ ngành <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="courseName" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Hệ đào tạo <span class="text-danger">*</span></label>
                                    <select class="form-select" id="courseEducationSystem" required>
                                        <option value="">Chọn hệ đào tạo...</option>
                                        ${educationSystems.map(sys => `<option value="${sys}">${sys}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Khóa tuyển sinh <span class="text-danger">*</span></label>
                                    <select class="form-select" id="courseAdmissionYear" required>
                                        <option value="">Chọn khóa...</option>
                                        ${admissionYears.map(year => `<option value="${year}">Khóa ${year}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Thời gian đào tạo (năm) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="courseDuration" value="4" min="2" max="6" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Số tín chỉ</label>
                                    <input type="number" class="form-control" id="courseCredits" value="120" min="1">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Khoa/Phòng quản lý</label>
                                <input type="text" class="form-control" id="courseDepartment">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Mô tả chi tiết</label>
                                <textarea class="form-control" id="courseDeion" rows="4" placeholder="Mô tả về ngành học, chương trình đào tạo..."></textarea>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-3" onclick="loadCourses()">Hủy</button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>Lưu thông tin
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `);
            
            $('#addCourseForm').submit(async function(e) {
                e.preventDefault();
                
                const courseData = {
                    code: $('#courseCode').val(),
                    name: $('#courseName').val(),
                    education_system: $('#courseEducationSystem').val(),
                    admission_year: parseInt($('#courseAdmissionYear').val()),
                    duration: parseInt($('#courseDuration').val()) || 4,
                    total_credits: parseInt($('#courseCredits').val()) || 120,
                    department: $('#courseDepartment').val(),
                    deion: $('#courseDeion').val()
                };
                
                const result = await apiRequest('/courses', {
                    method: 'POST',
                    body: JSON.stringify(courseData)
                });
                
                if (result?.success) {
                    showToast('Thêm ngành học thành công!', 'success');
                    setTimeout(() => loadCourses(), 1000);
                } else {
                    showToast(result?.message || 'Lỗi khi thêm ngành học', 'error');
                }
            });
        }
        
        async function showEditCourseForm(id) {
            const result = await apiRequest(`/courses/${id}`);
            
            if (!result?.success) {
                showToast('Không thể tải thông tin ngành học', 'error');
                return;
            }
            
            const course = result.data;
            
            const educationSystems = [
                'Đại học',
                'Cao đẳng', 
                'Chất lượng cao',
                'Liên thông',
                'Vừa học vừa làm'
            ];
            
            const currentYear = new Date().getFullYear();
            const admissionYears = [];
            for (let year = currentYear + 1; year >= 2000; year--) {
                admissionYears.push(year);
            }
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-edit me-2"></i>Chỉnh sửa: ${course.name}</h3>
                    <button class="btn btn-secondary" onclick="loadCourses()">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <form id="editCourseForm">
                            <input type="hidden" id="courseId" value="${course.id}">
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Mã ngành <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editCourseCode" value="${course.code}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tên ngành <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editCourseName" value="${course.name}" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Hệ đào tạo <span class="text-danger">*</span></label>
                                    <select class="form-select" id="editCourseEducationSystem" required>
                                        ${educationSystems.map(sys => 
                                            `<option value="${sys}" ${course.education_system === sys ? 'selected' : ''}>${sys}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Khóa tuyển sinh <span class="text-danger">*</span></label>
                                    <select class="form-select" id="editCourseAdmissionYear" required>
                                        ${admissionYears.map(year => 
                                            `<option value="${year}" ${course.admission_year == year ? 'selected' : ''}>Khóa ${year}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Thời gian đào tạo (năm) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="editCourseDuration" value="${course.duration}" min="2" max="6" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Số tín chỉ</label>
                                    <input type="number" class="form-control" id="editCourseCredits" value="${course.total_credits}" min="1">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Khoa/Phòng quản lý</label>
                                <input type="text" class="form-control" id="editCourseDepartment" value="${course.department || ''}">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Mô tả chi tiết</label>
                                <textarea class="form-control" id="editCourseDeion" rows="4">${course.deion || ''}</textarea>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-3" onclick="loadCourses()">Hủy</button>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-sync-alt me-2"></i>Cập nhật
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `);
            
            $('#editCourseForm').submit(async function(e) {
                e.preventDefault();
                
                const courseData = {
                    code: $('#editCourseCode').val(),
                    name: $('#editCourseName').val(),
                    education_system: $('#editCourseEducationSystem').val(),
                    admission_year: parseInt($('#editCourseAdmissionYear').val()),
                    duration: parseInt($('#editCourseDuration').val()) || 4,
                    total_credits: parseInt($('#editCourseCredits').val()) || 120,
                    department: $('#editCourseDepartment').val(),
                    deion: $('#editCourseDeion').val()
                };
                
                const result = await apiRequest(`/courses/${course.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(courseData)
                });
                
                if (result?.success) {
                    showToast('Cập nhật ngành học thành công!', 'success');
                    setTimeout(() => loadCourses(), 1000);
                } else {
                    showToast(result?.message || 'Lỗi khi cập nhật ngành học', 'error');
                }
            });
        }
        
        async function deleteCourse(id) {
            if (!confirm('Bạn có chắc muốn xóa khóa học này?')) return;
            
            const result = await apiRequest(`/courses/${id}`, {
                method: 'DELETE'
            });
            
            if (result?.success) {
                showToast('Đã xóa khóa học thành công', 'success');
                if ($.fn.DataTable.isDataTable('#coursesTable')) {
                    $('#coursesTable').DataTable().ajax.reload();
                }
            } else {
                showToast(result?.message || 'Lỗi khi xóa khóa học', 'error');
            }
        }
        
        async function viewCourseDetail(id) {
            const result = await apiRequest(`/courses/${id}`);
            
            if (!result?.success) {
                showToast('Không thể tải thông tin chi tiết', 'error');
                return;
            }
            
            const course = result.data;
            
            // Load danh sách môn học thuộc ngành này
            const subjectsRes = await apiRequest(`/subjects/course/${id}`);
            const subjects = subjectsRes?.success ? subjectsRes.data : [];
            
            let subjectsHtml = '';
            if (subjects.length > 0) {
                subjects.forEach(subject => {
                    const typeBadge = subject.subject_type === 'Bắt buộc' ? 'bg-danger' : 'bg-success';
                    subjectsHtml += `
                        <div class="card mb-2">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${subject.code} - ${subject.name}</h6>
                                        <div class="small">
                                            <span class="badge ${typeBadge} me-2">${subject.subject_type}</span>
                                            <span class="badge bg-info me-2">${subject.credits} TC</span>
                                            ${subject.semester ? `<span class="badge bg-warning">HK ${subject.semester}</span>` : ''}
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-info" onclick="viewSubjectDetail(${subject.id})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                subjectsHtml = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Chưa có môn học nào thuộc ngành này
                        ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                        <br>
                        <button class="btn btn-sm btn-primary mt-2" onclick="showAddSubjectFormForCourse(${course.id})">
                            <i class="fas fa-plus me-1"></i>Thêm môn học
                        </button>
                        ` : ''}
                    </div>
                `;
            }
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-info-circle me-2"></i>Chi tiết: ${course.name}</h3>
                    <button class="btn btn-secondary" onclick="loadCourses()">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Thông tin chi tiết</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered">
                                    <tr>
                                        <th width="30%">Mã:</th>
                                        <td><span class="badge bg-primary">${course.code}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Tên:</th>
                                        <td><strong>${course.name}</strong></td>
                                    </tr>
                                    <tr>
                                        <th>Hệ đào tạo:</th>
                                        <td><span class="badge bg-info">${course.education_system}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Khóa tuyển sinh:</th>
                                        <td><span class="badge bg-warning">Khóa ${course.admission_year}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Thời gian đào tạo:</th>
                                        <td>${course.duration} năm</td>
                                    </tr>
                                    <tr>
                                        <th>Số tín chỉ:</th>
                                        <td><span class="badge bg-success">${course.total_credits} tín chỉ</span></td>
                                    </tr>
                                    <tr>
                                        <th>Khoa/Phòng:</th>
                                        <td>${course.department || 'Chưa cập nhật'}</td>
                                    </tr>
                                    <tr>
                                        <th>Mô tả:</th>
                                        <td>${course.deion || 'Không có mô tả'}</td>
                                    </tr>
                                    <tr>
                                        <th>Ngày tạo:</th>
                                        <td>${new Date(course.created_at).toLocaleDateString('vi-VN')}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-book-open me-2"></i>Danh sách môn học thuộc ngành</h5>
                                ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                                <button class="btn btn-sm btn-primary" onclick="showAddSubjectFormForCourse(${course.id})">
                                    <i class="fas fa-plus me-1"></i>Thêm môn học
                                </button>
                                ` : ''}
                            </div>
                            <div class="card-body">
                                ${subjectsHtml}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Thao tác</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                                    <button class="btn btn-warning" onclick="showEditCourseForm(${course.id})">
                                        <i class="fas fa-edit me-2"></i>Chỉnh sửa
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteCourse(${course.id})">
                                        <i class="fas fa-trash me-2"></i>Xóa
                                    </button>
                                    ` : ''}
                                    <button class="btn btn-outline-primary" onclick="loadProgramsByCourse(${course.id})">
                                        <i class="fas fa-book me-2"></i>Xem CTĐT liên quan
                                    </button>
                                    <button class="btn btn-outline-success" onclick="exportCourseSubjectsExcel(${course.id})">
                                        <i class="fas fa-file-excel me-2"></i>Xuất DS môn học
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5 class="mb-0">Thống kê</h5>
                            </div>
                            <div class="card-body">
                                <p><i class="fas fa-book me-2"></i>Tổng môn học: <strong>${subjects.length}</strong></p>
                                <p><i class="fas fa-list-check me-2"></i>Môn bắt buộc: <strong>${subjects.filter(s => s.subject_type === 'Bắt buộc').length}</strong></p>
                                <p><i class="fas fa-list me-2"></i>Môn tự chọn: <strong>${subjects.filter(s => s.subject_type === 'Tự chọn').length}</strong></p>
                                <p><i class="fas fa-clock me-2"></i>Thời gian: <strong>${course.duration} năm</strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        function showAddSubjectFormForCourse(courseId) {
            loadSubjects();
            
            setTimeout(() => {
                if ($('#filterSubjectCourse').length) {
                    $('#filterSubjectCourse').val(courseId);
                    searchSubjects();
                }
            }, 500);
        }
        
        async function exportCoursesExcel() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showToast('Vui lòng đăng nhập lại', 'error');
                    logout();
                    return;
                }
                
                const url = API_BASE_URL + '/courses/export/excel';
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        showToast('Phiên đăng nhập hết hạn', 'error');
                        logout();
                        return;
                    }
                    
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Lỗi server: ${response.status}`);
                }
                
                const blob = await response.blob();
                
                if (blob.size < 1000) {
                    throw new Error('File Excel không hợp lệ hoặc rỗng');
                }
                
                const urlObject = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = urlObject;
                a.download = 'danh-sach-nganh-hoc.xlsx';
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    window.URL.revokeObjectURL(urlObject);
                    document.body.removeChild(a);
                }, 100);
                
                showToast('Xuất Excel ngành học thành công!', 'success');
                
            } catch (error) {
                console.error('Export courses error:', error);
                
                let errorMessage = error.message;
                if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorMessage = 'Lỗi kết nối server. Vui lòng kiểm tra server có đang chạy không.';
                }
                
                showToast(`Lỗi xuất Excel: ${errorMessage}`, 'error');
            }
        }
        
        async function exportCourseSubjectsExcel(courseId) {
            try {
                const token = localStorage.getItem('token');
                const url = API_BASE_URL + `/subjects/course/${courseId}/export/excel`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `Server error: ${response.status}`);
                    } else {
                        const text = await response.text();
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                }
                
                const blob = await response.blob();
                
                if (blob.size === 0) {
                    throw new Error('File Excel rỗng');
                }
                
                const urlObject = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = urlObject;
                a.download = `danh-sach-mon-hoc-nganh-${courseId}.xlsx`;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    window.URL.revokeObjectURL(urlObject);
                    document.body.removeChild(a);
                }, 100);
                
                showToast('Xuất Excel danh sách môn học thành công!', 'success');
                
            } catch (error) {
                console.error('Export course subjects error:', error);
                showToast(`Lỗi xuất Excel: ${error.message}`, 'error');
            }
        }
        
        // ==================== SUBJECT MANAGEMENT ====================
        async function loadSubjects() {
            currentPage = 'subjects';
            updateActiveMenu();
            
            const coursesRes = await apiRequest('/courses');
            let courseOptions = '<option value="">Tất cả ngành</option>';
            
            if (coursesRes?.success && coursesRes.data) {
                coursesRes.data.forEach(course => {
                    courseOptions += `<option value="${course.id}">${course.code} - ${course.name}</option>`;
                });
            }
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-book-open me-2"></i>Quản lý Môn học</h3>
                    <div>
                        ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                        <button class="btn btn-primary me-2" onclick="showAddSubjectForm()">
                            <i class="fas fa-plus me-2"></i>Thêm mới
                        </button>
                        ` : ''}
                        <button class="btn btn-warning" onclick="exportSubjectsExcel()">
                            <i class="fas fa-file-excel me-2"></i>Xuất Excel
                        </button>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchSubject" placeholder="Tìm kiếm mã, tên môn...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterSubjectType">
                                    <option value="">Tất cả loại</option>
                                    <option value="Bắt buộc">Bắt buộc</option>
                                    <option value="Tự chọn">Tự chọn</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterSubjectCourse">
                                    ${courseOptions}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="searchSubjects()">
                                    <i class="fas fa-search me-2"></i>Tìm kiếm
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table id="subjectsTable" class="table table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Mã môn</th>
                                <th>Tên môn</th>
                                <th>Số TC</th>
                                <th>Loại môn</th>
                                <th>Ngành</th>
                                <th>Học kỳ</th>
                                <th>Mô tả</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded by DataTables -->
                        </tbody>
                    </table>
                </div>
            `);
            
            initializeSubjectsTable();
        }

        function initializeSubjectsTable() {
            if ($.fn.DataTable.isDataTable('#subjectsTable')) {
                $('#subjectsTable').DataTable().destroy();
            }
            
            const table = $('#subjectsTable').DataTable({
                processing: true,
                serverSide: false,
                ajax: {
                    url: API_BASE_URL + '/subjects',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    dataSrc: 'data'
                },
                columns: [
                    { 
                        data: null,
                        render: function(data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { 
                        data: 'code',
                        render: function(data) {
                            return `<span class="badge bg-primary">${data}</span>`;
                        }
                    },
                    { data: 'name' },
                    { 
                        data: 'credits',
                        render: function(data) {
                            return `<span class="badge bg-info">${data} TC</span>`;
                        }
                    },
                    { 
                        data: 'subject_type',
                        render: function(data) {
                            const badgeClass = data === 'Bắt buộc' ? 'bg-danger' : 'bg-success';
                            return `<span class="badge ${badgeClass}">${data}</span>`;
                        }
                    },
                    { 
                        data: 'course',
                        render: function(data) {
                            return data ? `${data.code} - ${data.name}` : '<span class="text-muted">Không xác định</span>';
                        }
                    },
                    { 
                        data: 'semester',
                        render: function(data) {
                            return data ? `HK ${data}` : '-';
                        }
                    },
                    { 
                        data: 'deion',
                        render: function(data) {
                            return data ? data.substring(0, 50) + '...' : '';
                        }
                    },
                    {
                        data: 'id',
                        render: function(data, type, row) {
                            let actions = `
                                <button class="btn btn-sm btn-info me-1" onclick="viewSubjectDetail(${data})" title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </button>
                            `;
                            
                            if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                                actions += `
                                    <button class="btn btn-sm btn-warning me-1" onclick="showEditSubjectForm(${data})" title="Sửa">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteSubject(${data})" title="Xóa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                `;
                            }
                            
                            return '<div class="action-buttons">' + actions + '</div>';
                        }
                    }
                ],
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json'
                },
                pageLength: 10,
                order: [[0, 'asc']]
            });
        }

        async function showAddSubjectForm() {
            const coursesRes = await apiRequest('/courses');
            let courseOptions = '<option value="">Không thuộc ngành nào</option>';
            
            if (coursesRes?.success && coursesRes.data) {
                coursesRes.data.forEach(course => {
                    courseOptions += `<option value="${course.id}">${course.code} - ${course.name}</option>`;
                });
            }
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-plus-circle me-2"></i>Thêm Môn học mới</h3>
                    <button class="btn btn-secondary" onclick="loadSubjects()">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <form id="addSubjectForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Mã môn học <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="subjectCode" required>
                                    <div class="form-text">Mã duy nhất, không trùng lặp</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tên môn học <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="subjectName" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Số tín chỉ <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="subjectCredits" value="3" min="1" max="10" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Loại môn học</label>
                                    <select class="form-select" id="subjectType">
                                        <option value="Bắt buộc">Bắt buộc</option>
                                        <option value="Tự chọn">Tự chọn</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Học kỳ (nếu có)</label>
                                    <input type="number" class="form-control" id="subjectSemester" min="1" max="16">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Thuộc ngành</label>
                                <select class="form-select" id="subjectCourse">
                                    ${courseOptions}
                                </select>
                                <div class="form-text">Có thể để trống nếu là môn học chung</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Mô tả môn học</label>
                                <textarea class="form-control" id="subjectDeion" rows="3" placeholder="Mô tả chi tiết về môn học..."></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Link tài liệu giáo trình</label>
                                <textarea class="form-control" id="subjectCurriculumLinks" rows="3" placeholder="Mỗi link trên một dòng..."></textarea>
                                <div class="form-text">Nhập mỗi link trên một dòng riêng</div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-3" onclick="loadSubjects()">Hủy</button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>Lưu môn học
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `);
            
            $('#addSubjectForm').submit(async function(e) {
                e.preventDefault();
                
                const subjectData = {
                    code: $('#subjectCode').val(),
                    name: $('#subjectName').val(),
                    credits: parseInt($('#subjectCredits').val()) || 3,
                    subject_type: $('#subjectType').val(),
                    course_id: $('#subjectCourse').val() || null,
                    deion: $('#subjectDeion').val(),
                    curriculum_links: $('#subjectCurriculumLinks').val(),
                    semester: $('#subjectSemester').val() || null
                };
                
                const result = await apiRequest('/subjects', {
                    method: 'POST',
                    body: JSON.stringify(subjectData)
                });
                
                if (result?.success) {
                    showToast('Thêm môn học thành công!', 'success');
                    setTimeout(() => loadSubjects(), 1000);
                } else {
                    showToast(result?.message || 'Lỗi khi thêm môn học', 'error');
                }
            });
        }

        async function viewSubjectDetail(id) {
            const result = await apiRequest(`/subjects/${id}`);
            
            if (!result?.success) {
                showToast('Không thể tải thông tin chi tiết', 'error');
                return;
            }
            
            const subject = result.data;
            
            let linksHtml = '<p class="text-muted">Không có tài liệu</p>';
            if (subject.curriculum_links) {
                const links = subject.curriculum_links.split('\n').filter(link => link.trim());
                linksHtml = '<ul class="list-unstyled">';
                links.forEach(link => {
                    linksHtml += `<li><a href="${link.trim()}" target="_blank" class="text-decoration-none">${link.trim()}</a></li>`;
                });
                linksHtml += '</ul>';
            }
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-info-circle me-2"></i>Chi tiết: ${subject.name}</h3>
                    <button class="btn btn-secondary" onclick="loadSubjects()">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Thông tin chi tiết môn học</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered">
                                    <tr>
                                        <th width="30%">Mã môn:</th>
                                        <td><span class="badge bg-primary">${subject.code}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Tên môn:</th>
                                        <td><strong>${subject.name}</strong></td>
                                    </tr>
                                    <tr>
                                        <th>Số tín chỉ:</th>
                                        <td><span class="badge bg-info">${subject.credits} tín chỉ</span></td>
                                    </tr>
                                    <tr>
                                        <th>Loại môn:</th>
                                        <td>
                                            ${subject.subject_type === 'Bắt buộc' 
                                                ? '<span class="badge bg-danger">Bắt buộc</span>' 
                                                : '<span class="badge bg-success">Tự chọn</span>'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Thuộc ngành:</th>
                                        <td>${subject.course ? `${subject.course.code} - ${subject.course.name}` : '<span class="text-muted">Không xác định</span>'}</td>
                                    </tr>
                                    <tr>
                                        <th>Học kỳ:</th>
                                        <td>${subject.semester ? `Học kỳ ${subject.semester}` : '-'}</td>
                                    </tr>
                                    <tr>
                                        <th>Mô tả:</th>
                                        <td>${subject.deion || 'Không có mô tả'}</td>
                                    </tr>
                                    <tr>
                                        <th>Tài liệu:</th>
                                        <td>${linksHtml}</td>
                                    </tr>
                                    <tr>
                                        <th>Ngày tạo:</th>
                                        <td>${new Date(subject.created_at).toLocaleDateString('vi-VN')}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Thao tác</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                                    <button class="btn btn-warning" onclick="showEditSubjectForm(${subject.id})">
                                        <i class="fas fa-edit me-2"></i>Chỉnh sửa
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteSubject(${subject.id})">
                                        <i class="fas fa-trash me-2"></i>Xóa
                                    </button>
                                    ` : ''}
                                    ${subject.course ? `
                                    <button class="btn btn-outline-primary" onclick="viewCourseDetail(${subject.course.id})">
                                        <i class="fas fa-graduation-cap me-2"></i>Xem ngành học
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        ${subject.course ? `
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5 class="mb-0">Thông tin ngành học</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>${subject.course.code} - ${subject.course.name}</strong></p>
                                <p>Hệ: <span class="badge bg-info">${subject.course.education_system}</span></p>
                                <p>Khóa: <span class="badge bg-warning">${subject.course.admission_year}</span></p>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `);
        }

        async function showEditSubjectForm(id) {
            const result = await apiRequest(`/subjects/${id}`);
            
            if (!result?.success) {
                showToast('Không thể tải thông tin môn học', 'error');
                return;
            }
            
            const subject = result.data;
            
            const coursesRes = await apiRequest('/courses');
            let courseOptions = '<option value="">Không thuộc ngành nào</option>';
            
            if (coursesRes?.success && coursesRes.data) {
                coursesRes.data.forEach(course => {
                    const selected = course.id === subject.course_id ? 'selected' : '';
                    courseOptions += `<option value="${course.id}" ${selected}>${course.code} - ${course.name}</option>`;
                });
            }
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-edit me-2"></i>Chỉnh sửa: ${subject.name}</h3>
                    <button class="btn btn-secondary" onclick="loadSubjects()">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <form id="editSubjectForm">
                            <input type="hidden" id="subjectId" value="${subject.id}">
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Mã môn học <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editSubjectCode" value="${subject.code}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tên môn học <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editSubjectName" value="${subject.name}" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Số tín chỉ <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="editSubjectCredits" value="${subject.credits}" min="1" max="10" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Loại môn học</label>
                                    <select class="form-select" id="editSubjectType">
                                        <option value="Bắt buộc" ${subject.subject_type === 'Bắt buộc' ? 'selected' : ''}>Bắt buộc</option>
                                        <option value="Tự chọn" ${subject.subject_type === 'Tự chọn' ? 'selected' : ''}>Tự chọn</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Học kỳ (nếu có)</label>
                                    <input type="number" class="form-control" id="editSubjectSemester" value="${subject.semester || ''}" min="1" max="16">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Thuộc ngành</label>
                                <select class="form-select" id="editSubjectCourse">
                                    ${courseOptions}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Mô tả môn học</label>
                                <textarea class="form-control" id="editSubjectDeion" rows="3">${subject.deion || ''}</textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Link tài liệu giáo trình</label>
                                <textarea class="form-control" id="editSubjectCurriculumLinks" rows="3" placeholder="Mỗi link trên một dòng...">${subject.curriculum_links || ''}</textarea>
                                <div class="form-text">Nhập mỗi link trên một dòng riêng</div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-3" onclick="loadSubjects()">Hủy</button>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-sync-alt me-2"></i>Cập nhật
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `);
            
            $('#editSubjectForm').submit(async function(e) {
                e.preventDefault();
                
                const subjectData = {
                    code: $('#editSubjectCode').val(),
                    name: $('#editSubjectName').val(),
                    credits: parseInt($('#editSubjectCredits').val()) || 3,
                    subject_type: $('#editSubjectType').val(),
                    course_id: $('#editSubjectCourse').val() || null,
                    deion: $('#editSubjectDeion').val(),
                    curriculum_links: $('#editSubjectCurriculumLinks').val(),
                    semester: $('#editSubjectSemester').val() || null
                };
                
                const result = await apiRequest(`/subjects/${subject.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(subjectData)
                });
                
                if (result?.success) {
                    showToast('Cập nhật môn học thành công!', 'success');
                    setTimeout(() => loadSubjects(), 1000);
                } else {
                    showToast(result?.message || 'Lỗi khi cập nhật môn học', 'error');
                }
            });
        }

        async function deleteSubject(id) {
            if (!confirm('Bạn có chắc muốn xóa môn học này?')) return;
            
            const result = await apiRequest(`/subjects/${id}`, {
                method: 'DELETE'
            });
            
            if (result?.success) {
                showToast('Đã xóa môn học thành công', 'success');
                if ($.fn.DataTable.isDataTable('#subjectsTable')) {
                    $('#subjectsTable').DataTable().ajax.reload();
                }
            } else {
                showToast(result?.message || 'Lỗi khi xóa môn học', 'error');
            }
        }

        function searchSubjects() {
            const searchText = $('#searchSubject').val();
            const subjectType = $('#filterSubjectType').val();
            const courseId = $('#filterSubjectCourse').val();
            
            let url = API_BASE_URL + '/subjects';
            const params = [];
            
            if (searchText) params.push(`search=${encodeURIComponent(searchText)}`);
            if (subjectType) params.push(`subject_type=${encodeURIComponent(subjectType)}`);
            if (courseId) params.push(`course_id=${encodeURIComponent(courseId)}`);
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            if ($.fn.DataTable.isDataTable('#subjectsTable')) {
                const table = $('#subjectsTable').DataTable();
                table.ajax.url(url).load();
                showToast(`Đã tìm kiếm môn học`, 'info');
            }
        }

        async function exportSubjectsExcel() {
            try {
                const response = await fetch(API_BASE_URL + '/subjects/export/excel', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Export error response:', errorText);
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const blob = await response.blob();
                
                if (blob.size === 0) {
                    throw new Error('File Excel rỗng');
                }
                
                const urlObject = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = urlObject;
                a.download = 'danh-sach-mon-hoc.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(urlObject);
                document.body.removeChild(a);
                
                showToast('Xuất Excel môn học thành công!', 'success');
                
            } catch (error) {
                console.error('Export subjects error:', error);
                showToast(`Lỗi xuất Excel: ${error.message}`, 'error');
            }
        }

        // ==================== PROGRAM MANAGEMENT ====================
        async function loadPrograms() {
            currentPage = 'programs';
            updateActiveMenu();
            
            const coursesRes = await apiRequest('/courses');
            let courseOptions = '<option value="">Tất cả khóa/ngành</option>';
            
            if (coursesRes?.success && coursesRes.data) {
                coursesRes.data.forEach(course => {
                    courseOptions += `<option value="${course.id}">${course.code} - ${course.name}</option>`;
                });
            }
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-book me-2"></i>Quản lý Chương trình Đào tạo (CTĐT)</h3>
                    <div>
                        ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                        <button class="btn btn-primary me-2" onclick="showAddProgramForm()">
                            <i class="fas fa-plus me-2"></i>Thêm mới
                        </button>
                        ` : ''}
                        <button class="btn btn-warning" onclick="exportProgramsExcel()">
                            <i class="fas fa-file-excel me-2"></i>Xuất Excel
                        </button>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchProgram" placeholder="Tìm kiếm mã CTĐT, tên, mô tả...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterProgramStatus">
                                    <option value="">Tất cả trạng thái</option>
                                    <option value="draft">Nháp</option>
                                    <option value="pending">Chờ duyệt</option>
                                    <option value="approved">Đã duyệt</option>
                                    <option value="inactive">Ngừng hoạt động</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterProgramCourse">
                                    ${courseOptions}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="searchPrograms()">
                                    <i class="fas fa-search me-2"></i>Tìm kiếm
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table id="programsTable" class="table table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Mã CTĐT</th>
                                <th>Tên CTĐT</th>
                                <th>Mã ngành</th>
                                <th>Tên ngành</th>
                                <th>Năm học</th>
                                <th>Số HK</th>
                                <th>Số TC</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded by DataTables -->
                        </tbody>
                    </table>
                </div>
            `);
            
            initializeProgramsTable();
        }
        
        function initializeProgramsTable() {
            if ($.fn.DataTable.isDataTable('#programsTable')) {
                $('#programsTable').DataTable().destroy();
            }
            
            const table = $('#programsTable').DataTable({
                processing: true,
                serverSide: false,
                ajax: {
                    url: API_BASE_URL + '/programs',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    dataSrc: 'data'
                },
                columns: [
                    { 
                        data: null,
                        render: function(data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { 
                        data: 'program_code',
                        render: function(data) {
                            return '<span class="badge bg-primary">' + data + '</span>';
                        }
                    },
                    { data: 'program_name' },
                    { 
                        data: 'course.code',
                        render: function(data, type, row) {
                            return data || '-';
                        }
                    },
                    { 
                        data: 'course.name',
                        render: function(data, type, row) {
                            return data || '-';
                        }
                    },
                    { data: 'academic_year' },
                    { data: 'total_semesters' },
                    { 
                        data: 'total_credits',
                        render: function(data) {
                            return '<span class="badge bg-info">' + data + ' TC</span>';
                        }
                    },
                    {
                        data: 'status',
                        render: function(data) {
                            const statusMap = {
                                'draft': { class: 'badge-draft', text: 'Nháp' },
                                'pending': { class: 'badge-pending', text: 'Chờ duyệt' },
                                'approved': { class: 'badge-approved', text: 'Đã duyệt' },
                                'inactive': { class: 'badge-inactive', text: 'Ngừng HĐ' }
                            };
                            const status = statusMap[data] || { class: 'badge-secondary', text: data };
                            return `<span class="badge-status ${status.class}">${status.text}</span>`;
                        }
                    },
                    {
                        data: 'id',
                        render: function(data, type, row) {
                            let actions = `
                                <button class="btn btn-sm btn-info me-1" onclick="viewProgramDetail(${data})" title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </button>
                            `;
                            
                            if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                                actions += `
                                    <button class="btn btn-sm btn-warning me-1" onclick="showEditProgramForm(${data})" title="Sửa">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteProgram(${data})" title="Xóa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                `;
                            }
                            
                            return '<div class="action-buttons">' + actions + '</div>';
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json'
                },
                pageLength: 10,
                order: [[0, 'asc']]
            });
        }
        
        async function showAddProgramForm() {
            const coursesRes = await apiRequest('/courses');
            let courseOptions = '<option value="">Chọn ngành học...</option>';
            
            if (coursesRes?.success && coursesRes.data) {
                coursesRes.data.forEach(course => {
                    courseOptions += `
                        <option value="${course.id}">
                            ${course.code} - ${course.name} 
                            (Hệ: ${course.education_system}, Khóa: ${course.admission_year})
                        </option>`;
                });
            }
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-plus-circle me-2"></i>Thêm Chương trình Đào tạo mới</h3>
                    <button class="btn btn-secondary" onclick="loadPrograms()">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <form id="addProgramForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Mã CTĐT <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="programCode" required>
                                    <div class="form-text">VD: CTDT-CNTT-DH-2023</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tên CTĐT <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="programName" required>
                                    <div class="form-text">VD: Chương trình đào tạo CNTT hệ Đại học</div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ngành học <span class="text-danger">*</span></label>
                                    <select class="form-select" id="programCourse" required>
                                        ${courseOptions}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Năm học <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="programYear" placeholder="VD: 2023-2027" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Số học kỳ</label>
                                    <input type="number" class="form-control" id="programSemesters" value="8" min="1" max="16">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Số tín chỉ</label>
                                    <input type="number" class="form-control" id="programCredits" value="120" min="1">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Trạng thái</label>
                                    <select class="form-select" id="programStatus">
                                        <option value="draft">Nháp</option>
                                        <option value="pending">Chờ duyệt</option>
                                        <option value="approved">Đã duyệt</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Mô tả chi tiết</label>
                                <textarea class="form-control" id="programDeion" rows="4" placeholder="Mô tả về chương trình đào tạo..."></textarea>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-3" onclick="loadPrograms()">Hủy</button>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-2"></i>Lưu CTĐT
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `);
            
            $('#addProgramForm').submit(async function(e) {
                e.preventDefault();
                
                const programData = {
                    program_code: $('#programCode').val(),
                    program_name: $('#programName').val(),
                    course_id: $('#programCourse').val(),
                    academic_year: $('#programYear').val(),
                    total_semesters: parseInt($('#programSemesters').val()) || 8,
                    total_credits: parseInt($('#programCredits').val()) || 120,
                    deion: $('#programDeion').val(),
                    status: $('#programStatus').val()
                };
                
                const result = await apiRequest('/programs', {
                    method: 'POST',
                    body: JSON.stringify(programData)
                });
                
                if (result?.success) {
                    showToast('Thêm chương trình đào tạo thành công!', 'success');
                    setTimeout(() => loadPrograms(), 1000);
                } else {
                    showToast(result?.message || 'Lỗi khi thêm CTĐT', 'error');
                }
            });
        }
        
        async function showEditProgramForm(id) {
            const result = await apiRequest(`/programs/${id}`);
            
            if (!result?.success) {
                showToast('Không thể tải thông tin CTĐT', 'error');
                return;
            }
            
            const program = result.data;
            
            const coursesRes = await apiRequest('/courses');
            let courseOptions = '';
            
            if (coursesRes?.success && coursesRes.data) {
                coursesRes.data.forEach(course => {
                    const selected = course.id === program.course_id ? 'selected' : '';
                    courseOptions += `
                        <option value="${course.id}" ${selected}>
                            ${course.code} - ${course.name} 
                            (Hệ: ${course.education_system}, Khóa: ${course.admission_year})
                        </option>`;
                });
            }
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-edit me-2"></i>Chỉnh sửa: ${program.program_name}</h3>
                    <button class="btn btn-secondary" onclick="loadPrograms()">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <form id="editProgramForm">
                            <input type="hidden" id="programId" value="${program.id}">
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Mã CTĐT <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editProgramCode" value="${program.program_code}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tên CTĐT <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editProgramName" value="${program.program_name}" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ngành học <span class="text-danger">*</span></label>
                                    <select class="form-select" id="editProgramCourse" required>
                                        ${courseOptions}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Năm học <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editProgramYear" value="${program.academic_year}" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Số học kỳ</label>
                                    <input type="number" class="form-control" id="editProgramSemesters" value="${program.total_semesters}" min="1" max="16">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Số tín chỉ</label>
                                    <input type="number" class="form-control" id="editProgramCredits" value="${program.total_credits}" min="1">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Trạng thái</label>
                                    <select class="form-select" id="editProgramStatus">
                                        <option value="draft" ${program.status === 'draft' ? 'selected' : ''}>Nháp</option>
                                        <option value="pending" ${program.status === 'pending' ? 'selected' : ''}>Chờ duyệt</option>
                                        <option value="approved" ${program.status === 'approved' ? 'selected' : ''}>Đã duyệt</option>
                                        <option value="inactive" ${program.status === 'inactive' ? 'selected' : ''}>Ngừng hoạt động</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Mô tả chi tiết</label>
                                <textarea class="form-control" id="editProgramDeion" rows="4">${program.deion || ''}</textarea>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-3" onclick="loadPrograms()">Hủy</button>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-sync-alt me-2"></i>Cập nhật
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `);
            
            $('#editProgramForm').submit(async function(e) {
                e.preventDefault();
                
                const programData = {
                    program_code: $('#editProgramCode').val(),
                    program_name: $('#editProgramName').val(),
                    course_id: $('#editProgramCourse').val(),
                    academic_year: $('#editProgramYear').val(),
                    total_semesters: parseInt($('#editProgramSemesters').val()) || 8,
                    total_credits: parseInt($('#editProgramCredits').val()) || 120,
                    deion: $('#editProgramDeion').val(),
                    status: $('#editProgramStatus').val()
                };
                
                const result = await apiRequest(`/programs/${program.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(programData)
                });
                
                if (result?.success) {
                    showToast('Cập nhật CTĐT thành công!', 'success');
                    setTimeout(() => loadPrograms(), 1000);
                } else {
                    showToast(result?.message || 'Lỗi khi cập nhật CTĐT', 'error');
                }
            });
        }
        
        async function deleteProgram(id) {
            if (!confirm('Bạn có chắc muốn xóa chương trình đào tạo này?')) return;
            
            const result = await apiRequest(`/programs/${id}`, {
                method: 'DELETE'
            });
            
            if (result?.success) {
                showToast('Đã xóa CTĐT thành công', 'success');
                if ($.fn.DataTable.isDataTable('#programsTable')) {
                    $('#programsTable').DataTable().ajax.reload();
                }
            } else {
                showToast(result?.message || 'Lỗi khi xóa CTĐT', 'error');
            }
        }
        
        async function viewProgramDetail(id) {
            const result = await apiRequest(`/programs/${id}`);
            
            if (!result?.success) {
                showToast('Không thể tải thông tin chi tiết', 'error');
                return;
            }
            
            const program = result.data;
            const statusText = {
                'draft': { class: 'badge-draft', text: 'Nháp' },
                'pending': { class: 'badge-pending', text: 'Chờ duyệt' },
                'approved': { class: 'badge-approved', text: 'Đã duyệt' },
                'inactive': { class: 'badge-inactive', text: 'Ngừng hoạt động' }
            }[program.status] || { class: 'badge-secondary', text: program.status };
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-info-circle me-2"></i>Chi tiết: ${program.program_name}</h3>
                    <button class="btn btn-secondary" onclick="loadPrograms()">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Thông tin chi tiết Chương trình Đào tạo</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered">
                                    <tr>
                                        <th width="30%">Mã CTĐT:</th>
                                        <td><span class="badge bg-primary">${program.program_code}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Tên CTĐT:</th>
                                        <td><strong>${program.program_name}</strong></td>
                                    </tr>
                                    <tr>
                                        <th>Mã ngành:</th>
                                        <td>${program.course?.code || '-'}</td>
                                    </tr>
                                    <tr>
                                        <th>Tên ngành:</th>
                                        <td>${program.course?.name || '-'}</td>
                                    </tr>
                                    <tr>
                                        <th>Hệ đào tạo:</th>
                                        <td>${program.course?.education_system || '-'}</td>
                                    </tr>
                                    <tr>
                                        <th>Khóa tuyển sinh:</th>
                                        <td>${program.course?.admission_year ? 'Khóa ' + program.course.admission_year : '-'}</td>
                                    </tr>
                                    <tr>
                                        <th>Năm học:</th>
                                        <td>${program.academic_year}</td>
                                    </tr>
                                    <tr>
                                        <th>Số học kỳ:</th>
                                        <td>${program.total_semesters} học kỳ</td>
                                    </tr>
                                    <tr>
                                        <th>Số tín chỉ:</th>
                                        <td><span class="badge bg-info">${program.total_credits} tín chỉ</span></td>
                                    </tr>
                                    <tr>
                                        <th>Trạng thái:</th>
                                        <td><span class="badge-status ${statusText.class}">${statusText.text}</span></td>
                                    </tr>
                                    <tr>
                                        <th>Mô tả:</th>
                                        <td>${program.deion || 'Không có mô tả'}</td>
                                    </tr>
                                    <tr>
                                        <th>Ngày tạo:</th>
                                        <td>${new Date(program.created_at).toLocaleDateString('vi-VN')}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Thao tác</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                                    <button class="btn btn-warning" onclick="showEditProgramForm(${program.id})">
                                        <i class="fas fa-edit me-2"></i>Chỉnh sửa
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteProgram(${program.id})">
                                        <i class="fas fa-trash me-2"></i>Xóa
                                    </button>
                                    ` : ''}
                                    <button class="btn btn-outline-warning" onclick="exportSingleProgramExcel(${program.id})">
                                        <i class="fas fa-file-excel me-2"></i>Xuất Excel CTĐT
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5 class="mb-0">Thông tin ngành học</h5>
                            </div>
                            <div class="card-body">
                                ${program.course ? `
                                <p><strong>${program.course.code} - ${program.course.name}</strong></p>
                                <p>Hệ: <span class="badge bg-info">${program.course.education_system}</span></p>
                                <p>Khóa: <span class="badge bg-warning">Khóa ${program.course.admission_year}</span></p>
                                <p>Thời gian: ${program.course.duration} năm</p>
                                <p>Số tín chỉ: ${program.course.total_credits}</p>
                                ${program.course.department ? `<p>Khoa: ${program.course.department}</p>` : ''}
                                ` : '<p class="text-muted">Không có thông tin ngành học</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }

        async function exportSingleProgramExcel(programId) {
            try {
                const token = localStorage.getItem('token');
                const url = API_BASE_URL + `/programs/${programId}/export/excel`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const blob = await response.blob();
                
                if (blob.size === 0) {
                    throw new Error('File Excel rỗng');
                }
                
                const urlObject = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = urlObject;
                a.download = `chuong-trinh-dao-tao-${programId}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(urlObject);
                document.body.removeChild(a);
                
                showToast('Xuất Excel CTĐT thành công!', 'success');
                
            } catch (error) {
                console.error('Export program error:', error);
                showToast(`Lỗi xuất Excel: ${error.message}`, 'error');
            }
        }

        async function exportProgramsExcel() {
            try {
                const token = localStorage.getItem('token');
                const url = API_BASE_URL + '/programs/export/excel';
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const blob = await response.blob();
                
                if (blob.size === 0) {
                    throw new Error('File Excel rỗng');
                }
                
                const urlObject = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = urlObject;
                a.download = 'danh-sach-chuong-trinh-dao-tao.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(urlObject);
                document.body.removeChild(a);
                
                showToast('Xuất Excel CTĐT thành công!', 'success');
                
            } catch (error) {
                console.error('Export programs error:', error);
                showToast(`Lỗi xuất Excel: ${error.message}`, 'error');
            }
        }

        // ==================== SEARCH FUNCTIONS ====================
        function searchCourses() {
            const searchText = $('#searchCourse').val();
            const educationSystem = $('#filterCourseEducationSystem').val();
            
            let url = API_BASE_URL + '/courses';
            const params = [];
            
            if (searchText) params.push(`search=${encodeURIComponent(searchText)}`);
            if (educationSystem) params.push(`type=${encodeURIComponent(educationSystem)}`);
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            if ($.fn.DataTable.isDataTable('#coursesTable')) {
                const table = $('#coursesTable').DataTable();
                table.ajax.url(url).load();
                showToast(`Đã tìm kiếm: ${searchText || 'tất cả'}`, 'info');
            }
        }

        function resetCourseSearch() {
            $('#searchCourse').val('');
            $('#filterCourseEducationSystem').val('');
            
            if ($.fn.DataTable.isDataTable('#coursesTable')) {
                const table = $('#coursesTable').DataTable();
                table.ajax.url(API_BASE_URL + '/courses').load();
            }
            
            showToast('Đã đặt lại tìm kiếm', 'info');
        }

        function searchPrograms() {
            const searchText = $('#searchProgram').val();
            const status = $('#filterProgramStatus').val();
            const courseId = $('#filterProgramCourse').val();
            
            let url = API_BASE_URL + '/programs';
            const params = [];
            
            if (searchText) params.push(`search=${encodeURIComponent(searchText)}`);
            if (status) params.push(`status=${encodeURIComponent(status)}`);
            if (courseId) params.push(`course_id=${encodeURIComponent(courseId)}`);
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            if ($.fn.DataTable.isDataTable('#programsTable')) {
                const table = $('#programsTable').DataTable();
                table.ajax.url(url).load();
                showToast(`Đã tìm kiếm chương trình đào tạo`, 'info');
            }
        }

        function loadProgramsByCourse(courseId) {
            loadPrograms();
            
            setTimeout(() => {
                $('#filterProgramCourse').val(courseId);
                searchPrograms();
            }, 500);
        }

        // ==================== HELPER FUNCTIONS ====================
        function updateActiveMenu() {
            $('.nav-link').removeClass('active');
            
            if (currentPage === 'dashboard') {
                $('.nav-link:contains("Dashboard")').addClass('active');
            } else if (currentPage === 'courses') {
                $('.nav-link:contains("Khóa/Hệ/Ngành")').addClass('active');
            } else if (currentPage === 'programs') {
                $('.nav-link:contains("CTĐT")').addClass('active');
            } else if (currentPage === 'subjects') {
                $('.nav-link:contains("Môn học")').addClass('active');
            }
        }
        
        function showProfile() {
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-user me-2"></i>Tài khoản của tôi</h3>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-user-circle fa-4x text-primary mb-3"></i>
                                <h4>${currentUser.full_name || currentUser.username}</h4>
                                <p class="text-muted">${currentUser.role === 'admin' ? 'Quản trị viên' : currentUser.role === 'manager' ? 'Quản lý' : 'Người dùng'}</p>
                                <p><i class="fas fa-envelope me-2"></i>${currentUser.email}</p>
                                ${currentUser.department ? `<p><i class="fas fa-building me-2"></i>${currentUser.department}</p>` : ''}
                                ${currentUser.phone ? `<p><i class="fas fa-phone me-2"></i>${currentUser.phone}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Thông tin hệ thống</h5>
                            </div>
                            <div class="card-body">
                                <p>Hệ thống Quản lý Đào tạo Đại học</p>
                                <p>Phiên bản: 1.0.0</p>
                                <p>Đăng nhập lúc: ${new Date().toLocaleString('vi-VN')}</p>
                                <hr>
                                <button class="btn btn-outline-primary me-2" onclick="showDashboard()">
                                    <i class="fas fa-home me-2"></i>Về trang chủ
                                </button>
                                <button class="btn btn-outline-danger" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        function logout() {
            if (confirm('Bạn có chắc muốn đăng xuất?')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
