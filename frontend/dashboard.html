<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #1a252f 100%);
            color: white;
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
        }
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border-left: 3px solid transparent;
            transition: all 0.3s;
            text-decoration: none;
        }
        .nav-link:hover, .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
            border-left-color: #3498db;
        }
        .stat-card {
            border-radius: 10px;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .badge-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-draft { background-color: #6c757d; }
        .badge-pending { background-color: #ffc107; color: #000; }
        .badge-approved { background-color: #28a745; }
        .badge-inactive { background-color: #dc3545; }
        .action-buttons .btn {
            padding: 3px 8px;
            margin: 2px;
        }
        .dataTables_wrapper {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                transition: left 0.3s;
            }
            .sidebar.show {
                left: 0;
            }
            .main-content {
                margin-left: 0;
            }
            .mobile-toggle {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Toggle Button -->
    <button class="btn btn-primary mobile-toggle d-md-none" style="position: fixed; top: 10px; left: 10px; z-index: 1001;">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-4 text-center">
            <i class="fas fa-university fa-3x mb-3 text-primary"></i>
            <h5 id="userName">Admin</h5>
            <small id="userRole" class="text-light">Qu·∫£n tr·ªã vi√™n</small>
            <div class="mt-3">
                <small class="text-muted">H·ªá th·ªëng Qu·∫£n l√Ω ƒê√†o t·∫°o</small>
            </div>
        </div>
        
        <nav class="nav flex-column mt-3">
            <a href="#" class="nav-link active" onclick="showDashboard()">
                <i class="fas fa-home me-2"></i>Dashboard
            </a>
            <a href="#" class="nav-link" onclick="loadCourses()">
                <i class="fas fa-graduation-cap me-2"></i>Qu·∫£n l√Ω Kh√≥a/H·ªá/Ng√†nh
            </a>
            <a href="#" class="nav-link" onclick="loadPrograms()">
                <i class="fas fa-book me-2"></i>Qu·∫£n l√Ω CTƒêT
            </a>
            <a href="#" class="nav-link" onclick="loadSubjects()">
                <i class="fas fa-book-open me-2"></i>Qu·∫£n l√Ω M√¥n h·ªçc
            </a>
            <hr class="text-white-50 mx-3">
            <a href="#" class="nav-link" onclick="showProfile()">
                <i class="fas fa-user me-2"></i>T√†i kho·∫£n
            </a>
            <a href="#" class="nav-link text-danger" onclick="logout()">
                <i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t
            </a>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div id="content">
            <!-- Dashboard will be loaded here -->
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">ƒêang t·∫£i...</p>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Th√¥ng b√°o</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    
    <script>
        // Global variables
        let currentUser = null;
        let currentPage = 'dashboard';
        
        // Initialize
        $(document).ready(function() {
            checkAuth();
            setupEventListeners();
        });
        
        function checkAuth() {
            const token = localStorage.getItem('token');
            const userData = localStorage.getItem('user');
            
            if (!token || !userData) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = JSON.parse(userData);
            updateUserInfo();
            showDashboard();
        }
        
        function updateUserInfo() {
            $('#userName').text(currentUser.full_name || currentUser.username);
            $('#userRole').text(
                currentUser.role === 'admin' ? 'Qu·∫£n tr·ªã vi√™n' : 
                currentUser.role === 'manager' ? 'Qu·∫£n l√Ω' : 'Ng∆∞·ªùi d√πng'
            );
        }
        
        function setupEventListeners() {
            // Mobile menu toggle
            $('.mobile-toggle').click(function() {
                $('.sidebar').toggleClass('show');
            });
            
            // Close sidebar when clicking outside on mobile
            $(document).click(function(e) {
                if ($(window).width() < 768) {
                    if (!$(e.target).closest('.sidebar').length && 
                        !$(e.target).closest('.mobile-toggle').length) {
                        $('.sidebar').removeClass('show');
                    }
                }
            });
        }
        
        // API Helper
        const API_BASE_URL = 'https://ctdt-manager-backend.onrender.com/api';
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const token = localStorage.getItem('token');
            
            const headers = {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
                ...options.headers
            };
            
            try {
                const response = await fetch(url, { ...options, headers });
                
                if (response.status === 401) {
                    // Token expired
                    localStorage.clear();
                    window.location.href = '/';
                    return null;
                }
                
                if (response.headers.get('content-type')?.includes('application/vnd.openxmlformats')) {
                    // This is an Excel file
                    return response.blob();
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showToast('L·ªói k·∫øt n·ªëi server', 'error');
                return null;
            }
        }
        
        // Toast notification
        function showToast(message, type = 'info', title = 'Th√¥ng b√°o') {
            const toast = $('#liveToast');
            $('#toastTitle').text(title);
            $('#toastMessage').text(message);
            
            toast.removeClass('bg-success bg-danger bg-warning bg-info');
            toast.addClass(`bg-${type}`);
            
            const bsToast = new bootstrap.Toast(toast[0]);
            bsToast.show();
        }
        
        // ==================== DASHBOARD ====================
        function showDashboard() {
            currentPage = 'dashboard';
            updateActiveMenu();
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-home me-2"></i>Dashboard</h3>
                    <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-2"></i>L√†m m·ªõi
                    </button>
                </div>
                
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6">
                        <div class="stat-card bg-primary">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">T·ªïng Kh√≥a/H·ªá/Ng√†nh</h6>
                                    <h2 id="totalCoursesCount">0</h2>
                                </div>
                                <i class="fas fa-graduation-cap fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="stat-card bg-success">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">T·ªïng CTƒêT</h6>
                                    <h2 id="totalProgramsCount">0</h2>
                                </div>
                                <i class="fas fa-book fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="stat-card bg-warning">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">CTƒêT Ch·ªù duy·ªát</h6>
                                    <h2 id="pendingProgramsCount">0</h2>
                                </div>
                                <i class="fas fa-clock fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="stat-card bg-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">CTƒêT ƒê√£ duy·ªát</h6>
                                    <h2 id="approvedProgramsCount">0</h2>
                                </div>
                                <i class="fas fa-check-circle fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Thao t√°c nhanh</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                                    <button class="btn btn-primary" onclick="showAddCourseForm()">
                                        <i class="fas fa-plus me-2"></i>Th√™m Kh√≥a/H·ªá/Ng√†nh
                                    </button>
                                    <button class="btn btn-success" onclick="showAddProgramForm()">
                                        <i class="fas fa-plus me-2"></i>Th√™m Ch∆∞∆°ng tr√¨nh ƒê√†o t·∫°o
                                    </button>
                                    ` : ''}
                                    <button class="btn btn-outline-primary" onclick="loadCourses()">
                                        <i class="fas fa-list me-2"></i>Xem danh s√°ch Kh√≥a h·ªçc
                                    </button>
                                    <button class="btn btn-outline-success" onclick="loadPrograms()">
                                        <i class="fas fa-list me-2"></i>Xem danh s√°ch CTƒêT
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>B√°o c√°o nhanh</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-warning" onclick="exportCoursesExcel()">
                                        <i class="fas fa-file-excel me-2"></i>Xu·∫•t Excel Kh√≥a h·ªçc
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="exportProgramsExcel()">
                                        <i class="fas fa-file-excel me-2"></i>Xu·∫•t Excel CTƒêT
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            loadDashboardData();
        }
        
        async function loadDashboardData() {
            try {
                const [coursesRes, programsRes] = await Promise.all([
                    apiRequest('/courses?limit=1'),
                    apiRequest('/programs')
                ]);
                
                if (coursesRes?.success) {
                    $('#totalCoursesCount').text(coursesRes.pagination?.total || coursesRes.data?.length || 0);
                }
                
                if (programsRes?.success) {
                    const programs = programsRes.data || [];
                    $('#totalProgramsCount').text(programsRes.pagination?.total || programs.length);
                    
                    const pending = programs.filter(p => p.status === 'pending').length;
                    const approved = programs.filter(p => p.status === 'approved').length;
                    
                    $('#pendingProgramsCount').text(pending);
                    $('#approvedProgramsCount').text(approved);
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        function refreshDashboard() {
            loadDashboardData();
            showToast('ƒê√£ l√†m m·ªõi d·ªØ li·ªáu', 'success');
        }
        
        // ==================== COURSE MANAGEMENT ====================
        async function loadCourses() {
            currentPage = 'courses';
            updateActiveMenu();
            
            $('#content').html(`
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-graduation-cap me-2"></i>Qu·∫£n l√Ω Ng√†nh h·ªçc</h3>
            <div>
                ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                <button class="btn btn-primary me-2" onclick="showAddCourseForm()">
                    <i class="fas fa-plus me-2"></i>Th√™m m·ªõi
                </button>
                ` : ''}
                <button class="btn btn-warning" onclick="exportCoursesExcel()">
                    <i class="fas fa-file-excel me-2"></i>Xu·∫•t Excel
                </button>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchCourse" placeholder="T√¨m ki·∫øm m√£, t√™n ng√†nh...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterCourseEducationSystem">
                            <option value="">T·∫•t c·∫£ h·ªá ƒë√†o t·∫°o</option>
                            <option value="ƒê·∫°i h·ªçc">ƒê·∫°i h·ªçc</option>
                            <option value="Cao ƒë·∫≥ng">Cao ƒë·∫≥ng</option>
                            <option value="Ch·∫•t l∆∞·ª£ng cao">Ch·∫•t l∆∞·ª£ng cao</option>
                            <option value="Li√™n th√¥ng">Li√™n th√¥ng</option>
                            <option value="V·ª´a h·ªçc v·ª´a l√†m">V·ª´a h·ªçc v·ª´a l√†m</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="searchCourses()">
                            <i class="fas fa-search me-2"></i>T√¨m ki·∫øm
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-secondary w-100" onclick="resetCourseSearch()">
                            <i class="fas fa-redo me-2"></i>ƒê·∫∑t l·∫°i
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table id="coursesTable" class="table table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>M√£ ng√†nh</th>
                        <th>T√™n ng√†nh</th>
                        <th>H·ªá</th>
                        <th>Kh√≥a</th>
                        <th>Th·ªùi gian</th>
                        <th>S·ªë t√≠n ch·ªâ</th>
                        <th>Khoa/Ph√≤ng</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded by DataTables -->
                </tbody>
            </table>
        </div>
    `);
            
            initializeCoursesTable();
        }
        
 function initializeCoursesTable() {
    if ($.fn.DataTable.isDataTable('#coursesTable')) {
        $('#coursesTable').DataTable().destroy();
    }
    
    const table = $('#coursesTable').DataTable({
        processing: true,
        serverSide: false,
        ajax: {
            url: 'https://ctdt-manager-backend.onrender.com/api/courses',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            dataSrc: 'data'
        },
        columns: [
            { 
                data: null,
                render: function(data, type, row, meta) {
                    return meta.row + 1;
                }
            },
            { 
                data: 'code',
                render: function(data) {
                    return `<span class="badge bg-primary">${data}</span>`;
                }
            },
            { data: 'name' },
            { 
                data: 'education_system',
                render: function(data) {
                    return `<span class="badge bg-info">${data}</span>`;
                }
            },
            { 
                data: 'admission_year',
                render: function(data) {
                    return `<span class="badge bg-warning">Kh√≥a ${data}</span>`;
                }
            },
            { 
                data: 'duration',
                render: function(data) {
                    return data + ' nƒÉm';
                }
            },
            { 
                data: 'total_credits',
                render: function(data) {
                    return '<span class="badge bg-success">' + data + ' TC</span>';
                }
            },
            { data: 'department' },
            {
                data: 'id',
                render: function(data, type, row) {
                    let actions = `
                        <button class="btn btn-sm btn-info me-1" onclick="viewCourseDetail(${data})" title="Xem chi ti·∫øt">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;
                    
                    if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                        actions += `
                            <button class="btn btn-sm btn-warning me-1" onclick="showEditCourseForm(${data})" title="S·ª≠a">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCourse(${data})" title="X√≥a">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                    }
                    
                    return '<div class="action-buttons">' + actions + '</div>';
                }
            }
        ],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json'
        },
        pageLength: 10,
        order: [[0, 'asc']]
    });
}
        
function showAddCourseForm() {
    // T·∫°o options cho h·ªá ƒë√†o t·∫°o
    const educationSystems = [
        'ƒê·∫°i h·ªçc',
        'Cao ƒë·∫≥ng', 
        'Ch·∫•t l∆∞·ª£ng cao',
        'Li√™n th√¥ng',
        'V·ª´a h·ªçc v·ª´a l√†m'
    ];
    
    // T·∫°o options cho kh√≥a tuy·ªÉn sinh (5 nƒÉm g·∫ßn ƒë√¢y + 1 nƒÉm t·ªõi)
    const currentYear = new Date().getFullYear();
    const admissionYears = [];
    for (let year = currentYear + 1; year >= currentYear - 4; year--) {
        admissionYears.push(year);
    }
    
    $('#content').html(`
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-plus-circle me-2"></i>Th√™m Ng√†nh h·ªçc m·ªõi</h3>
            <button class="btn btn-secondary" onclick="loadCourses()">
                <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
        </div>
        
        <div class="card">
            <div class="card-body">
                <form id="addCourseForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">M√£ ng√†nh <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="courseCode" required>
                            <div class="form-text">M√£ duy nh·∫•t cho ng√†nh h·ªçc, kh√¥ng tr√πng l·∫∑p</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">T√™n ƒë·∫ßy ƒë·ªß ng√†nh <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="courseName" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">H·ªá ƒë√†o t·∫°o <span class="text-danger">*</span></label>
                            <select class="form-select" id="courseEducationSystem" required>
                                <option value="">Ch·ªçn h·ªá ƒë√†o t·∫°o...</option>
                                ${educationSystems.map(sys => `<option value="${sys}">${sys}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Kh√≥a tuy·ªÉn sinh <span class="text-danger">*</span></label>
                            <select class="form-select" id="courseAdmissionYear" required>
                                <option value="">Ch·ªçn kh√≥a...</option>
                                ${admissionYears.map(year => `<option value="${year}">Kh√≥a ${year}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Th·ªùi gian ƒë√†o t·∫°o (nƒÉm) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="courseDuration" value="4" min="2" max="6" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">S·ªë t√≠n ch·ªâ</label>
                            <input type="number" class="form-control" id="courseCredits" value="120" min="1">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Khoa/Ph√≤ng qu·∫£n l√Ω</label>
                        <input type="text" class="form-control" id="courseDepartment">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">M√¥ t·∫£ chi ti·∫øt</label>
                        <textarea class="form-control" id="courseDescription" rows="4" placeholder="M√¥ t·∫£ v·ªÅ ng√†nh h·ªçc, ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o..."></textarea>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-3" onclick="loadCourses()">H·ªßy</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>L∆∞u th√¥ng tin
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `);
    
    $('#addCourseForm').submit(async function(e) {
        e.preventDefault();
        
        const courseData = {
            code: $('#courseCode').val(),
            name: $('#courseName').val(),
            education_system: $('#courseEducationSystem').val(),
            admission_year: parseInt($('#courseAdmissionYear').val()),
            duration: parseInt($('#courseDuration').val()) || 4,
            total_credits: parseInt($('#courseCredits').val()) || 120,
            department: $('#courseDepartment').val(),
            description: $('#courseDescription').val()
        };
        
        const result = await apiRequest('/courses', {
            method: 'POST',
            body: JSON.stringify(courseData)
        });
        
        if (result?.success) {
            showToast('Th√™m ng√†nh h·ªçc th√†nh c√¥ng!', 'success');
            setTimeout(() => loadCourses(), 1000);
        } else {
            showToast(result?.message || 'L·ªói khi th√™m ng√†nh h·ªçc', 'error');
        }
    });
}
        
        async function showEditCourseForm(id) {
    const result = await apiRequest(`/courses/${id}`);
    
    if (!result?.success) {
        showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng√†nh h·ªçc', 'error');
        return;
    }
    
    const course = result.data;
    
    // T·∫°o options cho h·ªá ƒë√†o t·∫°o
    const educationSystems = [
        'ƒê·∫°i h·ªçc',
        'Cao ƒë·∫≥ng', 
        'Ch·∫•t l∆∞·ª£ng cao',
        'Li√™n th√¥ng',
        'V·ª´a h·ªçc v·ª´a l√†m'
    ];
    
    // T·∫°o options cho kh√≥a tuy·ªÉn sinh
    const currentYear = new Date().getFullYear();
    const admissionYears = [];
    for (let year = currentYear + 1; year >= 2000; year--) {
        admissionYears.push(year);
    }
    
    $('#content').html(`
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a: ${course.name}</h3>
            <button class="btn btn-secondary" onclick="loadCourses()">
                <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
        </div>
        
        <div class="card">
            <div class="card-body">
                <form id="editCourseForm">
                    <input type="hidden" id="courseId" value="${course.id}">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">M√£ ng√†nh <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editCourseCode" value="${course.code}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">T√™n ng√†nh <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editCourseName" value="${course.name}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">H·ªá ƒë√†o t·∫°o <span class="text-danger">*</span></label>
                            <select class="form-select" id="editCourseEducationSystem" required>
                                ${educationSystems.map(sys => 
                                    `<option value="${sys}" ${course.education_system === sys ? 'selected' : ''}>${sys}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Kh√≥a tuy·ªÉn sinh <span class="text-danger">*</span></label>
                            <select class="form-select" id="editCourseAdmissionYear" required>
                                ${admissionYears.map(year => 
                                    `<option value="${year}" ${course.admission_year == year ? 'selected' : ''}>Kh√≥a ${year}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Th·ªùi gian ƒë√†o t·∫°o (nƒÉm) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="editCourseDuration" value="${course.duration}" min="2" max="6" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">S·ªë t√≠n ch·ªâ</label>
                            <input type="number" class="form-control" id="editCourseCredits" value="${course.total_credits}" min="1">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Khoa/Ph√≤ng qu·∫£n l√Ω</label>
                        <input type="text" class="form-control" id="editCourseDepartment" value="${course.department || ''}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">M√¥ t·∫£ chi ti·∫øt</label>
                        <textarea class="form-control" id="editCourseDescription" rows="4">${course.description || ''}</textarea>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-3" onclick="loadCourses()">H·ªßy</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-sync-alt me-2"></i>C·∫≠p nh·∫≠t
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `);
    
    $('#editCourseForm').submit(async function(e) {
        e.preventDefault();
        
        const courseData = {
            code: $('#editCourseCode').val(),
            name: $('#editCourseName').val(),
            education_system: $('#editCourseEducationSystem').val(),
            admission_year: parseInt($('#editCourseAdmissionYear').val()),
            duration: parseInt($('#editCourseDuration').val()) || 4,
            total_credits: parseInt($('#editCourseCredits').val()) || 120,
            department: $('#editCourseDepartment').val(),
            description: $('#editCourseDescription').val()
        };
        
        const result = await apiRequest(`/courses/${course.id}`, {
            method: 'PUT',
            body: JSON.stringify(courseData)
        });
        
        if (result?.success) {
            showToast('C·∫≠p nh·∫≠t ng√†nh h·ªçc th√†nh c√¥ng!', 'success');
            setTimeout(() => loadCourses(), 1000);
        } else {
            showToast(result?.message || 'L·ªói khi c·∫≠p nh·∫≠t ng√†nh h·ªçc', 'error');
        }
    });
}
        
        async function deleteCourse(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh√≥a h·ªçc n√†y?')) return;
            
            const result = await apiRequest(`/courses/${id}`, {
                method: 'DELETE'
            });
            
            if (result?.success) {
                showToast('ƒê√£ x√≥a kh√≥a h·ªçc th√†nh c√¥ng', 'success');
                if ($.fn.DataTable.isDataTable('#coursesTable')) {
                    $('#coursesTable').DataTable().ajax.reload();
                }
            } else {
                showToast(result?.message || 'L·ªói khi x√≥a kh√≥a h·ªçc', 'error');
            }
        }
        
        async function viewCourseDetail(id) {
    const result = await apiRequest(`/courses/${id}`);
    
    if (!result?.success) {
        showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin chi ti·∫øt', 'error');
        return;
    }
    
    const course = result.data;
    
    // Load danh s√°ch m√¥n h·ªçc thu·ªôc ng√†nh n√†y
    const subjectsRes = await apiRequest(`/subjects/course/${id}`);
    const subjects = subjectsRes?.success ? subjectsRes.data : [];
    
    let subjectsHtml = '';
    if (subjects.length > 0) {
        subjects.forEach(subject => {
            const typeBadge = subject.subject_type === 'B·∫Øt bu·ªôc' ? 'bg-danger' : 'bg-success';
            subjectsHtml += `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${subject.code} - ${subject.name}</h6>
                                <div class="small">
                                    <span class="badge ${typeBadge} me-2">${subject.subject_type}</span>
                                    <span class="badge bg-info me-2">${subject.credits} TC</span>
                                    ${subject.semester ? `<span class="badge bg-warning">HK ${subject.semester}</span>` : ''}
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-info" onclick="viewSubjectDetail(${subject.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    } else {
        subjectsHtml = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Ch∆∞a c√≥ m√¥n h·ªçc n√†o thu·ªôc ng√†nh n√†y
                ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                <br>
                <button class="btn btn-sm btn-primary mt-2" onclick="showAddSubjectFormForCourse(${course.id})">
                    <i class="fas fa-plus me-1"></i>Th√™m m√¥n h·ªçc
                </button>
                ` : ''}
            </div>
        `;
    }
    
    $('#content').html(`
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-info-circle me-2"></i>Chi ti·∫øt: ${course.name}</h3>
            <button class="btn btn-secondary" onclick="loadCourses()">
                <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Th√¥ng tin chi ti·∫øt</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <tr>
                                <th width="30%">M√£:</th>
                                <td><span class="badge bg-primary">${course.code}</span></td>
                            </tr>
                            <tr>
                                <th>T√™n:</th>
                                <td><strong>${course.name}</strong></td>
                            </tr>
                            <tr>
                                <th>H·ªá ƒë√†o t·∫°o:</th>
                                <td><span class="badge bg-info">${course.education_system}</span></td>
                            </tr>
                            <tr>
                                <th>Kh√≥a tuy·ªÉn sinh:</th>
                                <td><span class="badge bg-warning">Kh√≥a ${course.admission_year}</span></td>
                            </tr>
                            <tr>
                                <th>Th·ªùi gian ƒë√†o t·∫°o:</th>
                                <td>${course.duration} nƒÉm</td>
                            </tr>
                            <tr>
                                <th>S·ªë t√≠n ch·ªâ:</th>
                                <td><span class="badge bg-success">${course.total_credits} t√≠n ch·ªâ</span></td>
                            </tr>
                            <tr>
                                <th>Khoa/Ph√≤ng:</th>
                                <td>${course.department || 'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
                            </tr>
                            <tr>
                                <th>M√¥ t·∫£:</th>
                                <td>${course.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</td>
                            </tr>
                            <tr>
                                <th>Ng√†y t·∫°o:</th>
                                <td>${new Date(course.created_at).toLocaleDateString('vi-VN')}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-book-open me-2"></i>Danh s√°ch m√¥n h·ªçc thu·ªôc ng√†nh</h5>
                        ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                        <button class="btn btn-sm btn-primary" onclick="showAddSubjectFormForCourse(${course.id})">
                            <i class="fas fa-plus me-1"></i>Th√™m m√¥n h·ªçc
                        </button>
                        ` : ''}
                    </div>
                    <div class="card-body">
                        ${subjectsHtml}
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Thao t√°c</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                            <button class="btn btn-warning" onclick="showEditCourseForm(${course.id})">
                                <i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a
                            </button>
                            <button class="btn btn-danger" onclick="deleteCourse(${course.id})">
                                <i class="fas fa-trash me-2"></i>X√≥a
                            </button>
                            ` : ''}
                            <button class="btn btn-outline-primary" onclick="loadProgramsByCourse(${course.id})">
                                <i class="fas fa-book me-2"></i>Xem CTƒêT li√™n quan
                            </button>
                            <button class="btn btn-outline-success" onclick="exportCourseSubjectsExcel(${course.id})">
                                <i class="fas fa-file-excel me-2"></i>Xu·∫•t DS m√¥n h·ªçc
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">Th·ªëng k√™</h5>
                    </div>
                    <div class="card-body">
                        <p><i class="fas fa-book me-2"></i>T·ªïng m√¥n h·ªçc: <strong>${subjects.length}</strong></p>
                        <p><i class="fas fa-list-check me-2"></i>M√¥n b·∫Øt bu·ªôc: <strong>${subjects.filter(s => s.subject_type === 'B·∫Øt bu·ªôc').length}</strong></p>
                        <p><i class="fas fa-list me-2"></i>M√¥n t·ª± ch·ªçn: <strong>${subjects.filter(s => s.subject_type === 'T·ª± ch·ªçn').length}</strong></p>
                        <p><i class="fas fa-clock me-2"></i>Th·ªùi gian: <strong>${course.duration} nƒÉm</strong></p>
                    </div>
                </div>
            </div>
        </div>
    `);
}

// H√†m th√™m m√¥n h·ªçc t·ª´ trang chi ti·∫øt ng√†nh
function showAddSubjectFormForCourse(courseId) {
    showAddSubjectForm();
    
    // Sau khi form ƒë∆∞·ª£c t·∫£i, ch·ªçn ng√†nh t·ª± ƒë·ªông
    setTimeout(() => {
        if ($('#subjectCourse').length) {
            $('#subjectCourse').val(courseId);
            showToast('ƒê√£ ch·ªçn ng√†nh h·ªçc hi·ªán t·∫°i', 'info');
        }
    }, 500);
}
async function exportCoursesExcel() {
    console.log('üîµ [FRONTEND] Exporting courses Excel...');
    
    try {
        // Hi·ªÉn th·ªã loading
        const originalTitle = document.title;
        document.title = 'ƒêang xu·∫•t Excel ng√†nh h·ªçc...';
        
        const token = localStorage.getItem('token');
        if (!token) {
            showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i', 'error');
            logout();
            return;
        }
        
        const url = 'https://ctdt-manager-backend.onrender.com/api/courses/export/excel';
        
        console.log('üîµ [FRONTEND] Fetching from:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/json'
            }
        });
        
        console.log('üîµ [FRONTEND] Response status:', response.status);
        
        if (!response.ok) {
            if (response.status === 401) {
                showToast('Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n', 'error');
                logout();
                return;
            }
            
            const errorText = await response.text();
            console.error('üîµ [FRONTEND] Error response:', errorText);
            throw new Error(`L·ªói server: ${response.status}`);
        }
        
        const blob = await response.blob();
        console.log('üîµ [FRONTEND] Blob size:', blob.size, 'bytes');
        
        if (blob.size < 1000) { // File Excel t·ªëi thi·ªÉu
            throw new Error('File Excel kh√¥ng h·ª£p l·ªá ho·∫∑c r·ªóng');
        }
        
        // T·∫°o URL v√† download
        const urlObject = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = urlObject;
        a.download = 'danh-sach-nganh-hoc.xlsx';
        
        // Th√™m v√†o DOM v√† click
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        setTimeout(() => {
            window.URL.revokeObjectURL(urlObject);
            document.body.removeChild(a);
            document.title = originalTitle;
        }, 100);
        
        showToast('Xu·∫•t Excel ng√†nh h·ªçc th√†nh c√¥ng!', 'success');
        
    } catch (error) {
        console.error('‚ùå [FRONTEND] Export courses error:', error);
        document.title = originalTitle;
        
        let errorMessage = error.message;
        if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
            errorMessage = 'L·ªói k·∫øt n·ªëi server. Vui l√≤ng ki·ªÉm tra server c√≥ ƒëang ch·∫°y kh√¥ng.';
        }
        
        showToast(`L·ªói xu·∫•t Excel: ${errorMessage}`, 'error');
        
        // Th·ª≠ fallback
        setTimeout(() => {
            if (confirm('Xu·∫•t Excel th·∫•t b·∫°i. B·∫°n c√≥ mu·ªën th·ª≠ ph∆∞∆°ng ph√°p kh√°c?')) {
                fallbackExportCourses();
            }
        }, 1500);
    }
}

// Fallback method cho xu·∫•t Excel ng√†nh h·ªçc
async function fallbackExportCourses() {
    console.log('üîÑ [FRONTEND] Trying fallback export for courses...');
    
    try {
        // L·∫•y d·ªØ li·ªáu t·ª´ API
        const coursesRes = await apiRequest('/courses');
        if (!coursesRes?.success || !coursesRes.data) {
            throw new Error('Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu ng√†nh h·ªçc');
        }
        
        const courses = coursesRes.data;
        if (courses.length === 0) {
            showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'warning');
            return;
        }
        
        // T·∫°o CSV
        let csv = 'STT,M√£ ng√†nh,T√™n ng√†nh,H·ªá ƒë√†o t·∫°o,Kh√≥a,Th·ªùi gian (nƒÉm),S·ªë t√≠n ch·ªâ,Khoa/Ph√≤ng,M√¥ t·∫£\n';
        
        courses.forEach((course, index) => {
            csv += `${index + 1},"${course.code}","${course.name}","${course.education_system}",${course.admission_year},${course.duration},${course.total_credits},"${course.department || ''}","${(course.description || '').replace(/"/g, '""')}"\n`;
        });
        
        // Download CSV
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'danh-sach-nganh-hoc.csv';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }, 100);
        
        showToast('ƒê√£ xu·∫•t file CSV thay th·∫ø!', 'info');
        
    } catch (error) {
        console.error('Fallback export error:', error);
        showToast('Fallback c≈©ng th·∫•t b·∫°i: ' + error.message, 'error');
    }
}
// H√†m xu·∫•t Excel danh s√°ch m√¥n h·ªçc theo ng√†nh - FIXED VERSION
async function exportCourseSubjectsExcel(courseId) {
    try {
        console.log('üîµ [FRONTEND] Exporting subjects for course:', courseId);
        
        const token = localStorage.getItem('token');
        const url = `/subjects/course/${courseId}/export/excel`;
        
        console.log('üîµ [FRONTEND] Fetching from:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        console.log('üîµ [FRONTEND] Response status:', response.status);
        console.log('üîµ [FRONTEND] Content-Type:', response.headers.get('content-type'));
        
        if (!response.ok) {
            // Ki·ªÉm tra n·∫øu l√† JSON error
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Server error: ${response.status}`);
            } else {
                const text = await response.text();
                console.error('üîµ [FRONTEND] Non-JSON response:', text.substring(0, 200));
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
        }
        
        // Ki·ªÉm tra content-type
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('spreadsheetml')) {
            console.warn('‚ö†Ô∏è [FRONTEND] Unexpected content type:', contentType);
        }
        
        const blob = await response.blob();
        console.log('üîµ [FRONTEND] Blob size:', blob.size, 'bytes');
        
        if (blob.size === 0) {
            throw new Error('File Excel r·ªóng');
        }
        
        // T·∫°o URL v√† download
        const urlObject = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = urlObject;
        a.download = `danh-sach-mon-hoc-nganh-${courseId}.xlsx`;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        setTimeout(() => {
            window.URL.revokeObjectURL(urlObject);
            document.body.removeChild(a);
        }, 100);
        
        showToast('Xu·∫•t Excel danh s√°ch m√¥n h·ªçc th√†nh c√¥ng!', 'success');
        
    } catch (error) {
        console.error('‚ùå [FRONTEND] Export course subjects error:', error);
        
        // Fallback: Th·ª≠ xu·∫•t th·ªß c√¥ng t·ª´ d·ªØ li·ªáu API
        try {
            await exportCourseSubjectsManual(courseId);
        } catch (fallbackError) {
            showToast(`L·ªói xu·∫•t Excel: ${error.message}`, 'error');
        }
    }
}

// Fallback method: T·∫°o Excel th·ªß c√¥ng t·ª´ API data
async function exportCourseSubjectsManual(courseId) {
    console.log('üîÑ [FRONTEND] Trying manual export for course:', courseId);
    
    // L·∫•y th√¥ng tin ng√†nh
    const courseRes = await apiRequest(`/courses/${courseId}`);
    if (!courseRes?.success) {
        throw new Error('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ng√†nh h·ªçc');
    }
    
    const course = courseRes.data;
    
    // L·∫•y danh s√°ch m√¥n h·ªçc
    const subjectsRes = await apiRequest(`/subjects/course/${courseId}`);
    if (!subjectsRes?.success || !subjectsRes.data || subjectsRes.data.length === 0) {
        throw new Error('Kh√¥ng c√≥ m√¥n h·ªçc ƒë·ªÉ xu·∫•t Excel');
    }
    
    const subjects = subjectsRes.data;
    
    // T·∫°o workbook b·∫±ng ExcelJS (ph·∫£i import ExcelJS trong frontend)
    if (typeof ExcelJS === 'undefined') {
        // N·∫øu ch∆∞a c√≥ ExcelJS, s·ª≠ d·ª•ng c√°ch ƒë∆°n gi·∫£n h∆°n
        await exportCourseSubjectsCSV(course, subjects);
        return;
    }
    
    // T·∫°o workbook v·ªõi ExcelJS
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet(`M√¥n h·ªçc - ${course.code}`);
    
    // ƒê·ªãnh nghƒ©a c·ªôt
    worksheet.columns = [
        { header: 'STT', key: 'stt', width: 8 },
        { header: 'M√É M√îN', key: 'code', width: 15 },
        { header: 'T√äN M√îN', key: 'name', width: 40 },
        { header: 'S·ªê TC', key: 'credits', width: 10 },
        { header: 'LO·∫†I', key: 'type', width: 12 },
        { header: 'H·ªåC K·ª≤', key: 'semester', width: 10 },
        { header: 'M√î T·∫¢', key: 'description', width: 50 }
    ];
    
    // Th√™m th√¥ng tin ng√†nh
    worksheet.addRow([`Ng√†nh: ${course.code} - ${course.name}`]);
    worksheet.addRow([`H·ªá: ${course.education_system}, Kh√≥a: ${course.admission_year}`]);
    worksheet.addRow([]);
    
    // Th√™m d·ªØ li·ªáu
    subjects.forEach((subject, index) => {
        worksheet.addRow({
            stt: index + 1,
            code: subject.code,
            name: subject.name,
            credits: subject.credits,
            type: subject.subject_type,
            semester: subject.semester || '',
            description: subject.description || ''
        });
    });
    
    // T·∫°o blob v√† download
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `danh-sach-mon-hoc-${course.code}.xlsx`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    showToast('Xu·∫•t Excel th·ªß c√¥ng th√†nh c√¥ng!', 'success');
}

// Xu·∫•t CSV n·∫øu kh√¥ng c√≥ ExcelJS
async function exportCourseSubjectsCSV(course, subjects) {
    console.log('üìÑ [FRONTEND] Exporting as CSV...');
    
    let csvContent = 'Ng√†nh: ' + course.code + ' - ' + course.name + '\r\n';
    csvContent += 'H·ªá: ' + course.education_system + ', Kh√≥a: ' + course.admission_year + '\r\n\r\n';
    csvContent += 'STT,M√É M√îN,T√äN M√îN,S·ªê TC,LO·∫†I,H·ªåC K·ª≤,M√î T·∫¢\r\n';
    
    subjects.forEach((subject, index) => {
        const row = [
            index + 1,
            `"${subject.code}"`,
            `"${subject.name}"`,
            subject.credits,
            `"${subject.subject_type}"`,
            subject.semester || '',
            `"${(subject.description || '').replace(/"/g, '""')}"`
        ];
        csvContent += row.join(',') + '\r\n';
    });
    
    // T·∫°o blob CSV
    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `danh-sach-mon-hoc-${course.code}.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    showToast('ƒê√£ xu·∫•t file CSV thay th·∫ø!', 'info');
}
        // ==================== SUBJECT MANAGEMENT ====================
async function loadSubjects() {
    currentPage = 'subjects';
    updateActiveMenu();
    
    // Load courses for filter
    const coursesRes = await apiRequest('/courses');
    let courseOptions = '<option value="">T·∫•t c·∫£ ng√†nh</option>';
    
    if (coursesRes?.success && coursesRes.data) {
        coursesRes.data.forEach(course => {
            courseOptions += `<option value="${course.id}">${course.code} - ${course.name}</option>`;
        });
    }
    
    $('#content').html(`
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-book-open me-2"></i>Qu·∫£n l√Ω M√¥n h·ªçc</h3>
            <div>
                ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                <button class="btn btn-primary me-2" onclick="showAddSubjectForm()">
                    <i class="fas fa-plus me-2"></i>Th√™m m·ªõi
                </button>
                ` : ''}
                <button class="btn btn-warning" onclick="exportSubjectsExcel()">
                    <i class="fas fa-file-excel me-2"></i>Xu·∫•t Excel
                </button>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchSubject" placeholder="T√¨m ki·∫øm m√£, t√™n m√¥n...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterSubjectType">
                            <option value="">T·∫•t c·∫£ lo·∫°i</option>
                            <option value="B·∫Øt bu·ªôc">B·∫Øt bu·ªôc</option>
                            <option value="T·ª± ch·ªçn">T·ª± ch·ªçn</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterSubjectCourse">
                            ${courseOptions}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="searchSubjects()">
                            <i class="fas fa-search me-2"></i>T√¨m ki·∫øm
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table id="subjectsTable" class="table table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>M√£ m√¥n</th>
                        <th>T√™n m√¥n</th>
                        <th>S·ªë TC</th>
                        <th>Lo·∫°i m√¥n</th>
                        <th>Ng√†nh</th>
                        <th>H·ªçc k·ª≥</th>
                        <th>M√¥ t·∫£</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded by DataTables -->
                </tbody>
            </table>
        </div>
    `);
    
    initializeSubjectsTable();
}

function initializeSubjectsTable() {
    if ($.fn.DataTable.isDataTable('#subjectsTable')) {
        $('#subjectsTable').DataTable().destroy();
    }
    
    const table = $('#subjectsTable').DataTable({
        processing: true,
        serverSide: false,
        ajax: {
            url: '/subjects',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            dataSrc: 'data'
        },
        columns: [
            { 
                data: null,
                render: function(data, type, row, meta) {
                    return meta.row + 1;
                }
            },
            { 
                data: 'code',
                render: function(data) {
                    return `<span class="badge bg-primary">${data}</span>`;
                }
            },
            { data: 'name' },
            { 
                data: 'credits',
                render: function(data) {
                    return `<span class="badge bg-info">${data} TC</span>`;
                }
            },
            { 
                data: 'subject_type',
                render: function(data) {
                    const badgeClass = data === 'B·∫Øt bu·ªôc' ? 'bg-danger' : 'bg-success';
                    return `<span class="badge ${badgeClass}">${data}</span>`;
                }
            },
            { 
                data: 'course',
                render: function(data) {
                    return data ? `${data.code} - ${data.name}` : '<span class="text-muted">Kh√¥ng x√°c ƒë·ªãnh</span>';
                }
            },
            { 
                data: 'semester',
                render: function(data) {
                    return data ? `HK ${data}` : '-';
                }
            },
            { 
                data: 'description',
                render: function(data) {
                    return data ? data.substring(0, 50) + '...' : '';
                }
            },
            {
                data: 'id',
                render: function(data, type, row) {
                    let actions = `
                        <button class="btn btn-sm btn-info me-1" onclick="viewSubjectDetail(${data})" title="Xem chi ti·∫øt">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;
                    
                    if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                        actions += `
                            <button class="btn btn-sm btn-warning me-1" onclick="showEditSubjectForm(${data})" title="S·ª≠a">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSubject(${data})" title="X√≥a">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                    }
                    
                    return '<div class="action-buttons">' + actions + '</div>';
                }
            }
        ],
        language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json'
        },
        pageLength: 10,
        order: [[0, 'asc']]
    });
}

async function showAddSubjectForm() {
    // Load courses for dropdown
    const coursesRes = await apiRequest('/courses');
    let courseOptions = '<option value="">Kh√¥ng thu·ªôc ng√†nh n√†o</option>';
    
    if (coursesRes?.success && coursesRes.data) {
        coursesRes.data.forEach(course => {
            courseOptions += `<option value="${course.id}">${course.code} - ${course.name}</option>`;
        });
    }
    
    $('#content').html(`
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-plus-circle me-2"></i>Th√™m M√¥n h·ªçc m·ªõi</h3>
            <button class="btn btn-secondary" onclick="loadSubjects()">
                <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
        </div>
        
        <div class="card">
            <div class="card-body">
                <form id="addSubjectForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">M√£ m√¥n h·ªçc <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="subjectCode" required>
                            <div class="form-text">M√£ duy nh·∫•t, kh√¥ng tr√πng l·∫∑p</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">T√™n m√¥n h·ªçc <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="subjectName" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">S·ªë t√≠n ch·ªâ <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="subjectCredits" value="3" min="1" max="10" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Lo·∫°i m√¥n h·ªçc</label>
                            <select class="form-select" id="subjectType">
                                <option value="B·∫Øt bu·ªôc">B·∫Øt bu·ªôc</option>
                                <option value="T·ª± ch·ªçn">T·ª± ch·ªçn</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">H·ªçc k·ª≥ (n·∫øu c√≥)</label>
                            <input type="number" class="form-control" id="subjectSemester" min="1" max="16">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Thu·ªôc ng√†nh</label>
                        <select class="form-select" id="subjectCourse">
                            ${courseOptions}
                        </select>
                        <div class="form-text">C√≥ th·ªÉ ƒë·ªÉ tr·ªëng n·∫øu l√† m√¥n h·ªçc chung</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">M√¥ t·∫£ m√¥n h·ªçc</label>
                        <textarea class="form-control" id="subjectDescription" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ m√¥n h·ªçc..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Link t√†i li·ªáu gi√°o tr√¨nh</label>
                        <textarea class="form-control" id="subjectCurriculumLinks" rows="3" placeholder="M·ªói link tr√™n m·ªôt d√≤ng..."></textarea>
                        <div class="form-text">Nh·∫≠p m·ªói link tr√™n m·ªôt d√≤ng ri√™ng</div>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-3" onclick="loadSubjects()">H·ªßy</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>L∆∞u m√¥n h·ªçc
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `);
    
    $('#addSubjectForm').submit(async function(e) {
        e.preventDefault();
        
        const subjectData = {
            code: $('#subjectCode').val(),
            name: $('#subjectName').val(),
            credits: parseInt($('#subjectCredits').val()) || 3,
            subject_type: $('#subjectType').val(),
            course_id: $('#subjectCourse').val() || null,
            description: $('#subjectDescription').val(),
            curriculum_links: $('#subjectCurriculumLinks').val(),
            semester: $('#subjectSemester').val() || null
        };
        
        const result = await apiRequest('/subjects', {
            method: 'POST',
            body: JSON.stringify(subjectData)
        });
        
        if (result?.success) {
            showToast('Th√™m m√¥n h·ªçc th√†nh c√¥ng!', 'success');
            setTimeout(() => loadSubjects(), 1000);
        } else {
            showToast(result?.message || 'L·ªói khi th√™m m√¥n h·ªçc', 'error');
        }
    });
}

async function viewSubjectDetail(id) {
    const result = await apiRequest(`/subjects/${id}`);
    
    if (!result?.success) {
        showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin chi ti·∫øt', 'error');
        return;
    }
    
    const subject = result.data;
    
    // Ph√¢n t√≠ch links n·∫øu c√≥
    let linksHtml = '<p class="text-muted">Kh√¥ng c√≥ t√†i li·ªáu</p>';
    if (subject.curriculum_links) {
        const links = subject.curriculum_links.split('\n').filter(link => link.trim());
        linksHtml = '<ul class="list-unstyled">';
        links.forEach(link => {
            linksHtml += `<li><a href="${link.trim()}" target="_blank" class="text-decoration-none">${link.trim()}</a></li>`;
        });
        linksHtml += '</ul>';
    }
    
    $('#content').html(`
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-info-circle me-2"></i>Chi ti·∫øt: ${subject.name}</h3>
            <button class="btn btn-secondary" onclick="loadSubjects()">
                <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Th√¥ng tin chi ti·∫øt m√¥n h·ªçc</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <tr>
                                <th width="30%">M√£ m√¥n:</th>
                                <td><span class="badge bg-primary">${subject.code}</span></td>
                            </tr>
                            <tr>
                                <th>T√™n m√¥n:</th>
                                <td><strong>${subject.name}</strong></td>
                            </tr>
                            <tr>
                                <th>S·ªë t√≠n ch·ªâ:</th>
                                <td><span class="badge bg-info">${subject.credits} t√≠n ch·ªâ</span></td>
                            </tr>
                            <tr>
                                <th>Lo·∫°i m√¥n:</th>
                                <td>
                                    ${subject.subject_type === 'B·∫Øt bu·ªôc' 
                                        ? '<span class="badge bg-danger">B·∫Øt bu·ªôc</span>' 
                                        : '<span class="badge bg-success">T·ª± ch·ªçn</span>'}
                                </td>
                            </tr>
                            <tr>
                                <th>Thu·ªôc ng√†nh:</th>
                                <td>${subject.course ? `${subject.course.code} - ${subject.course.name}` : '<span class="text-muted">Kh√¥ng x√°c ƒë·ªãnh</span>'}</td>
                            </tr>
                            <tr>
                                <th>H·ªçc k·ª≥:</th>
                                <td>${subject.semester ? `H·ªçc k·ª≥ ${subject.semester}` : '-'}</td>
                            </tr>
                            <tr>
                                <th>M√¥ t·∫£:</th>
                                <td>${subject.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</td>
                            </tr>
                            <tr>
                                <th>T√†i li·ªáu:</th>
                                <td>${linksHtml}</td>
                            </tr>
                            <tr>
                                <th>Ng√†y t·∫°o:</th>
                                <td>${new Date(subject.created_at).toLocaleDateString('vi-VN')}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Thao t√°c</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                            <button class="btn btn-warning" onclick="showEditSubjectForm(${subject.id})">
                                <i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a
                            </button>
                            <button class="btn btn-danger" onclick="deleteSubject(${subject.id})">
                                <i class="fas fa-trash me-2"></i>X√≥a
                            </button>
                            ` : ''}
                            ${subject.course ? `
                            <button class="btn btn-outline-primary" onclick="viewCourseDetail(${subject.course.id})">
                                <i class="fas fa-graduation-cap me-2"></i>Xem ng√†nh h·ªçc
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                ${subject.course ? `
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">Th√¥ng tin ng√†nh h·ªçc</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>${subject.course.code} - ${subject.course.name}</strong></p>
                        <p>H·ªá: <span class="badge bg-info">${subject.course.education_system}</span></p>
                        <p>Kh√≥a: <span class="badge bg-warning">${subject.course.admission_year}</span></p>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `);
}

// ==================== SUBJECT MANAGEMENT FUNCTIONS (CONTINUED) ====================

async function showEditSubjectForm(id) {
    const result = await apiRequest(`/subjects/${id}`);
    
    if (!result?.success) {
        showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin m√¥n h·ªçc', 'error');
        return;
    }
    
    const subject = result.data;
    
    // Load courses for dropdown
    const coursesRes = await apiRequest('/courses');
    let courseOptions = '<option value="">Kh√¥ng thu·ªôc ng√†nh n√†o</option>';
    
    if (coursesRes?.success && coursesRes.data) {
        coursesRes.data.forEach(course => {
            const selected = course.id === subject.course_id ? 'selected' : '';
            courseOptions += `<option value="${course.id}" ${selected}>${course.code} - ${course.name}</option>`;
        });
    }
    
    $('#content').html(`
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a: ${subject.name}</h3>
            <button class="btn btn-secondary" onclick="loadSubjects()">
                <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
        </div>
        
        <div class="card">
            <div class="card-body">
                <form id="editSubjectForm">
                    <input type="hidden" id="subjectId" value="${subject.id}">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">M√£ m√¥n h·ªçc <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editSubjectCode" value="${subject.code}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">T√™n m√¥n h·ªçc <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editSubjectName" value="${subject.name}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">S·ªë t√≠n ch·ªâ <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="editSubjectCredits" value="${subject.credits}" min="1" max="10" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Lo·∫°i m√¥n h·ªçc</label>
                            <select class="form-select" id="editSubjectType">
                                <option value="B·∫Øt bu·ªôc" ${subject.subject_type === 'B·∫Øt bu·ªôc' ? 'selected' : ''}>B·∫Øt bu·ªôc</option>
                                <option value="T·ª± ch·ªçn" ${subject.subject_type === 'T·ª± ch·ªçn' ? 'selected' : ''}>T·ª± ch·ªçn</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">H·ªçc k·ª≥ (n·∫øu c√≥)</label>
                            <input type="number" class="form-control" id="editSubjectSemester" value="${subject.semester || ''}" min="1" max="16">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Thu·ªôc ng√†nh</label>
                        <select class="form-select" id="editSubjectCourse">
                            ${courseOptions}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">M√¥ t·∫£ m√¥n h·ªçc</label>
                        <textarea class="form-control" id="editSubjectDescription" rows="3">${subject.description || ''}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Link t√†i li·ªáu gi√°o tr√¨nh</label>
                        <textarea class="form-control" id="editSubjectCurriculumLinks" rows="3" placeholder="M·ªói link tr√™n m·ªôt d√≤ng...">${subject.curriculum_links || ''}</textarea>
                        <div class="form-text">Nh·∫≠p m·ªói link tr√™n m·ªôt d√≤ng ri√™ng</div>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-3" onclick="loadSubjects()">H·ªßy</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-sync-alt me-2"></i>C·∫≠p nh·∫≠t
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `);
    
    $('#editSubjectForm').submit(async function(e) {
        e.preventDefault();
        
        const subjectData = {
            code: $('#editSubjectCode').val(),
            name: $('#editSubjectName').val(),
            credits: parseInt($('#editSubjectCredits').val()) || 3,
            subject_type: $('#editSubjectType').val(),
            course_id: $('#editSubjectCourse').val() || null,
            description: $('#editSubjectDescription').val(),
            curriculum_links: $('#editSubjectCurriculumLinks').val(),
            semester: $('#editSubjectSemester').val() || null
        };
        
        const result = await apiRequest(`/subjects/${subject.id}`, {
            method: 'PUT',
            body: JSON.stringify(subjectData)
        });
        
        if (result?.success) {
            showToast('C·∫≠p nh·∫≠t m√¥n h·ªçc th√†nh c√¥ng!', 'success');
            setTimeout(() => loadSubjects(), 1000);
        } else {
            showToast(result?.message || 'L·ªói khi c·∫≠p nh·∫≠t m√¥n h·ªçc', 'error');
        }
    });
}

async function deleteSubject(id) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√¥n h·ªçc n√†y?')) return;
    
    const result = await apiRequest(`/subjects/${id}`, {
        method: 'DELETE'
    });
    
    if (result?.success) {
        showToast('ƒê√£ x√≥a m√¥n h·ªçc th√†nh c√¥ng', 'success');
        if ($.fn.DataTable.isDataTable('#subjectsTable')) {
            $('#subjectsTable').DataTable().ajax.reload();
        }
    } else {
        showToast(result?.message || 'L·ªói khi x√≥a m√¥n h·ªçc', 'error');
    }
}

function searchSubjects() {
    const searchText = $('#searchSubject').val();
    const subjectType = $('#filterSubjectType').val();
    const courseId = $('#filterSubjectCourse').val();
    
    let url = 'https://ctdt-manager-backend.onrender.com/api/subjects';
    const params = [];
    
    if (searchText) params.push(`search=${encodeURIComponent(searchText)}`);
    if (subjectType) params.push(`subject_type=${encodeURIComponent(subjectType)}`);
    if (courseId) params.push(`course_id=${encodeURIComponent(courseId)}`);
    
    if (params.length > 0) {
        url += '?' + params.join('&');
    }
    
    if ($.fn.DataTable.isDataTable('#subjectsTable')) {
        const table = $('#subjectsTable').DataTable();
        table.ajax.url(url).load();
        showToast(`ƒê√£ t√¨m ki·∫øm m√¥n h·ªçc`, 'info');
    }
}

function resetSubjectSearch() {
    $('#searchSubject').val('');
    $('#filterSubjectType').val('');
    $('#filterSubjectCourse').val('');
    
    if ($.fn.DataTable.isDataTable('#subjectsTable')) {
        const table = $('#subjectsTable').DataTable();
        table.ajax.url('https://ctdt-manager-backend.onrender.com/api/subjects').load();
    }
    
    showToast('ƒê√£ ƒë·∫∑t l·∫°i t√¨m ki·∫øm', 'info');
}

async function exportSubjectsExcel() {
    try {
        const response = await fetch('https://ctdt-manager-backend.onrender.com/api/subjects/export/excel', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Export error response:', errorText);
            throw new Error(`Server error: ${response.status}`);
        }
        
        const blob = await response.blob();
        
        if (blob.size === 0) {
            throw new Error('File Excel r·ªóng');
        }
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'danh-sach-mon-hoc.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showToast('Xu·∫•t Excel m√¥n h·ªçc th√†nh c√¥ng!', 'success');
        
    } catch (error) {
        console.error('Export subjects error:', error);
        showToast(`L·ªói xu·∫•t Excel: ${error.message}`, 'error');
    }
}

// ==================== COURSE SEARCH FIX ====================

function searchCourses() {
    const searchText = $('#searchCourse').val();
    const educationSystem = $('#filterCourseEducationSystem').val();
    
    let url = 'https://ctdt-manager-backend.onrender.com/api/courses';
    const params = [];
    
    if (searchText) params.push(`search=${encodeURIComponent(searchText)}`);
    if (educationSystem) params.push(`type=${encodeURIComponent(educationSystem)}`);
    
    if (params.length > 0) {
        url += '?' + params.join('&');
    }
    
    if ($.fn.DataTable.isDataTable('#coursesTable')) {
        const table = $('#coursesTable').DataTable();
        table.ajax.url(url).load();
        showToast(`ƒê√£ t√¨m ki·∫øm: ${searchText || 't·∫•t c·∫£'}`, 'info');
    }
}

function resetCourseSearch() {
    $('#searchCourse').val('');
    $('#filterCourseEducationSystem').val('');
    
    if ($.fn.DataTable.isDataTable('#coursesTable')) {
        const table = $('#coursesTable').DataTable();
        table.ajax.url('https://ctdt-manager-backend.onrender.com/api/courses').load();
    }
    
    showToast('ƒê√£ ƒë·∫∑t l·∫°i t√¨m ki·∫øm', 'info');
}

// ==================== PROGRAM SEARCH FIX ====================

function searchPrograms() {
    const searchText = $('#searchProgram').val();
    const status = $('#filterProgramStatus').val();
    const courseId = $('#filterProgramCourse').val();
    
    let url = 'https://ctdt-manager-backend.onrender.com/api/programs';
    const params = [];
    
    if (searchText) params.push(`search=${encodeURIComponent(searchText)}`);
    if (status) params.push(`status=${encodeURIComponent(status)}`);
    if (courseId) params.push(`course_id=${encodeURIComponent(courseId)}`);
    
    if (params.length > 0) {
        url += '?' + params.join('&');
    }
    
    if ($.fn.DataTable.isDataTable('#programsTable')) {
        const table = $('#programsTable').DataTable();
        table.ajax.url(url).load();
        showToast(`ƒê√£ t√¨m ki·∫øm ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o`, 'info');
    }
}

// ==================== UPDATE ACTIVE MENU FOR SUBJECTS ====================

function updateActiveMenu() {
    $('.nav-link').removeClass('active');
    
    let selector = '';
    if (currentPage === 'dashboard') {
        selector = '.nav-link:contains("Dashboard")';
    } else if (currentPage === 'courses') {
        selector = '.nav-link:contains("Kh√≥a/H·ªá/Ng√†nh")';
    } else if (currentPage === 'programs') {
        selector = '.nav-link:contains("CTƒêT")';
    } else if (currentPage === 'subjects') {
        selector = '.nav-link:contains("M√¥n h·ªçc")';
    }
    
    $(selector).addClass('active');
}

// ==================== ADD EVENT LISTENERS FOR ENTER KEY ====================

$(document).ready(function() {
    // T√¨m ki·∫øm m√¥n h·ªçc b·∫±ng Enter
    $(document).on('keypress', '#searchSubject', function(e) {
        if (e.which === 13) {
            searchSubjects();
            return false;
        }
    });
    
    // T√¨m ki·∫øm kh√≥a h·ªçc b·∫±ng Enter
    $(document).on('keypress', '#searchCourse', function(e) {
        if (e.which === 13) {
            searchCourses();
            return false;
        }
    });
    
    // T√¨m ki·∫øm CTƒêT b·∫±ng Enter
    $(document).on('keypress', '#searchProgram', function(e) {
        if (e.which === 13) {
            searchPrograms();
            return false;
        }
    });
});
        // ==================== PROGRAM MANAGEMENT ====================
        async function loadPrograms() {
            currentPage = 'programs';
            updateActiveMenu();
            
            // Load courses for filter
            const coursesRes = await apiRequest('/courses');
            let courseOptions = '<option value="">T·∫•t c·∫£ kh√≥a/ng√†nh</option>';
            
            if (coursesRes?.success && coursesRes.data) {
                coursesRes.data.forEach(course => {
                    courseOptions += `<option value="${course.id}">${course.code} - ${course.name}</option>`;
                });
            }
            
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-book me-2"></i>Qu·∫£n l√Ω Ch∆∞∆°ng tr√¨nh ƒê√†o t·∫°o (CTƒêT)</h3>
                    <div>
                        ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                        <button class="btn btn-primary me-2" onclick="showAddProgramForm()">
                            <i class="fas fa-plus me-2"></i>Th√™m m·ªõi
                        </button>
                        ` : ''}
                        <button class="btn btn-warning" onclick="exportProgramsExcel()">
                            <i class="fas fa-file-excel me-2"></i>Xu·∫•t Excel
                        </button>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchProgram" placeholder="T√¨m ki·∫øm m√£ CTƒêT, t√™n, m√¥ t·∫£...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterProgramStatus">
                                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                    <option value="draft">Nh√°p</option>
                                    <option value="pending">Ch·ªù duy·ªát</option>
                                    <option value="approved">ƒê√£ duy·ªát</option>
                                    <option value="inactive">Ng·ª´ng ho·∫°t ƒë·ªông</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterProgramCourse">
                                    ${courseOptions}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="searchPrograms()">
                                    <i class="fas fa-search me-2"></i>T√¨m ki·∫øm
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table id="programsTable" class="table table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>M√£ CTƒêT</th>
                                <th>T√™n CTƒêT</th>
                                <th>M√£ ng√†nh</th>
                                <th>T√™n ng√†nh</th>
                                <th>NƒÉm h·ªçc</th>
                                <th>S·ªë HK</th>
                                <th>S·ªë TC</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded by DataTables -->
                        </tbody>
                    </table>
                </div>
            `);
            
            initializeProgramsTable();
        }
        
        function initializeProgramsTable() {
            if ($.fn.DataTable.isDataTable('#programsTable')) {
                $('#programsTable').DataTable().destroy();
            }
            
            const table = $('#programsTable').DataTable({
                processing: true,
                serverSide: false,
                ajax: {
                    url: 'https://ctdt-manager-backend.onrender.com/api/programs',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    dataSrc: 'data'
                },
                columns: [
                    { 
                        data: null,
                        render: function(data, type, row, meta) {
                            return meta.row + 1;
                        }
                    },
                    { 
                        data: 'program_code',
                        render: function(data) {
                            return '<span class="badge bg-primary">' + data + '</span>';
                        }
                    },
                    { data: 'program_name' },
                    { 
                        data: 'course.code',
                        render: function(data, type, row) {
                            return data || '-';
                        }
                    },
                    { 
                        data: 'course.name',
                        render: function(data, type, row) {
                            return data || '-';
                        }
                    },
                    { data: 'academic_year' },
                    { data: 'total_semesters' },
                    { 
                        data: 'total_credits',
                        render: function(data) {
                            return '<span class="badge bg-info">' + data + ' TC</span>';
                        }
                    },
                    {
                        data: 'status',
                        render: function(data) {
                            const statusMap = {
                                'draft': { class: 'badge-draft', text: 'Nh√°p' },
                                'pending': { class: 'badge-pending', text: 'Ch·ªù duy·ªát' },
                                'approved': { class: 'badge-approved', text: 'ƒê√£ duy·ªát' },
                                'inactive': { class: 'badge-inactive', text: 'Ng·ª´ng Hƒê' }
                            };
                            const status = statusMap[data] || { class: 'badge-secondary', text: data };
                            return `<span class="badge-status ${status.class}">${status.text}</span>`;
                        }
                    },
                    {
                        data: 'id',
                        render: function(data, type, row) {
                            let actions = `
                                <button class="btn btn-sm btn-info me-1" onclick="viewProgramDetail(${data})" title="Xem chi ti·∫øt">
                                    <i class="fas fa-eye"></i>
                                </button>
                            `;
                            
                            if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                                actions += `
                                    <button class="btn btn-sm btn-warning me-1" onclick="showEditProgramForm(${data})" title="S·ª≠a">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteProgram(${data})" title="X√≥a">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                `;
                            }
                            
                            return '<div class="action-buttons">' + actions + '</div>';
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json'
                },
                pageLength: 10,
                order: [[0, 'asc']]
            });
        }
        
async function showAddProgramForm() {
    // Load courses for dropdown
    const coursesRes = await apiRequest('/courses');
    let courseOptions = '<option value="">Ch·ªçn ng√†nh h·ªçc...</option>';
    
    if (coursesRes?.success && coursesRes.data) {
        coursesRes.data.forEach(course => {
            courseOptions += `
                <option value="${course.id}">
                    ${course.code} - ${course.name} 
                    (H·ªá: ${course.education_system}, Kh√≥a: ${course.admission_year})
                </option>`;
        });
    }
    
    $('#content').html(`
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-plus-circle me-2"></i>Th√™m Ch∆∞∆°ng tr√¨nh ƒê√†o t·∫°o m·ªõi</h3>
            <button class="btn btn-secondary" onclick="loadPrograms()">
                <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
        </div>
        
        <div class="card">
            <div class="card-body">
                <form id="addProgramForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">M√£ CTƒêT <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="programCode" required>
                            <div class="form-text">VD: CTDT-CNTT-DH-2023</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">T√™n CTƒêT <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="programName" required>
                            <div class="form-text">VD: Ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o CNTT h·ªá ƒê·∫°i h·ªçc</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ng√†nh h·ªçc <span class="text-danger">*</span></label>
                            <select class="form-select" id="programCourse" required>
                                ${courseOptions}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">NƒÉm h·ªçc <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="programYear" placeholder="VD: 2023-2027" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">S·ªë h·ªçc k·ª≥</label>
                            <input type="number" class="form-control" id="programSemesters" value="8" min="1" max="16">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">S·ªë t√≠n ch·ªâ</label>
                            <input type="number" class="form-control" id="programCredits" value="120" min="1">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tr·∫°ng th√°i</label>
                            <select class="form-select" id="programStatus">
                                <option value="draft">Nh√°p</option>
                                <option value="pending">Ch·ªù duy·ªát</option>
                                <option value="approved">ƒê√£ duy·ªát</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">M√¥ t·∫£ chi ti·∫øt</label>
                        <textarea class="form-control" id="programDescription" rows="4" placeholder="M√¥ t·∫£ v·ªÅ ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o..."></textarea>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-3" onclick="loadPrograms()">H·ªßy</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>L∆∞u CTƒêT
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `);
    
    $('#addProgramForm').submit(async function(e) {
        e.preventDefault();
        
        const programData = {
            program_code: $('#programCode').val(),
            program_name: $('#programName').val(),
            course_id: $('#programCourse').val(),
            academic_year: $('#programYear').val(),
            total_semesters: parseInt($('#programSemesters').val()) || 8,
            total_credits: parseInt($('#programCredits').val()) || 120,
            description: $('#programDescription').val(),
            status: $('#programStatus').val()
        };
        
        const result = await apiRequest('/programs', {
            method: 'POST',
            body: JSON.stringify(programData)
        });
        
        if (result?.success) {
            showToast('Th√™m ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o th√†nh c√¥ng!', 'success');
            setTimeout(() => loadPrograms(), 1000);
        } else {
            showToast(result?.message || 'L·ªói khi th√™m CTƒêT', 'error');
        }
    });
}
        
async function showEditProgramForm(id) {
    const result = await apiRequest(`/programs/${id}`);
    
    if (!result?.success) {
        showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin CTƒêT', 'error');
        return;
    }
    
    const program = result.data;
    
    // Load courses for dropdown
    const coursesRes = await apiRequest('/courses');
    let courseOptions = '';
    
    if (coursesRes?.success && coursesRes.data) {
        coursesRes.data.forEach(course => {
            const selected = course.id === program.course_id ? 'selected' : '';
            courseOptions += `
                <option value="${course.id}" ${selected}>
                    ${course.code} - ${course.name} 
                    (H·ªá: ${course.education_system}, Kh√≥a: ${course.admission_year})
                </option>`;
        });
    }
    
    $('#content').html(`
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a: ${program.program_name}</h3>
            <button class="btn btn-secondary" onclick="loadPrograms()">
                <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
        </div>
        
        <div class="card">
            <div class="card-body">
                <form id="editProgramForm">
                    <input type="hidden" id="programId" value="${program.id}">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">M√£ CTƒêT <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editProgramCode" value="${program.program_code}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">T√™n CTƒêT <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editProgramName" value="${program.program_name}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ng√†nh h·ªçc <span class="text-danger">*</span></label>
                            <select class="form-select" id="editProgramCourse" required>
                                ${courseOptions}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">NƒÉm h·ªçc <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editProgramYear" value="${program.academic_year}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">S·ªë h·ªçc k·ª≥</label>
                            <input type="number" class="form-control" id="editProgramSemesters" value="${program.total_semesters}" min="1" max="16">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">S·ªë t√≠n ch·ªâ</label>
                            <input type="number" class="form-control" id="editProgramCredits" value="${program.total_credits}" min="1">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tr·∫°ng th√°i</label>
                            <select class="form-select" id="editProgramStatus">
                                <option value="draft" ${program.status === 'draft' ? 'selected' : ''}>Nh√°p</option>
                                <option value="pending" ${program.status === 'pending' ? 'selected' : ''}>Ch·ªù duy·ªát</option>
                                <option value="approved" ${program.status === 'approved' ? 'selected' : ''}>ƒê√£ duy·ªát</option>
                                <option value="inactive" ${program.status === 'inactive' ? 'selected' : ''}>Ng·ª´ng ho·∫°t ƒë·ªông</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">M√¥ t·∫£ chi ti·∫øt</label>
                        <textarea class="form-control" id="editProgramDescription" rows="4">${program.description || ''}</textarea>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-3" onclick="loadPrograms()">H·ªßy</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-sync-alt me-2"></i>C·∫≠p nh·∫≠t
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `);
    
    $('#editProgramForm').submit(async function(e) {
        e.preventDefault();
        
        const programData = {
            program_code: $('#editProgramCode').val(),
            program_name: $('#editProgramName').val(),
            course_id: $('#editProgramCourse').val(),
            academic_year: $('#editProgramYear').val(),
            total_semesters: parseInt($('#editProgramSemesters').val()) || 8,
            total_credits: parseInt($('#editProgramCredits').val()) || 120,
            description: $('#editProgramDescription').val(),
            status: $('#editProgramStatus').val()
        };
        
        const result = await apiRequest(`/programs/${program.id}`, {
            method: 'PUT',
            body: JSON.stringify(programData)
        });
        
        if (result?.success) {
            showToast('C·∫≠p nh·∫≠t CTƒêT th√†nh c√¥ng!', 'success');
            setTimeout(() => loadPrograms(), 1000);
        } else {
            showToast(result?.message || 'L·ªói khi c·∫≠p nh·∫≠t CTƒêT', 'error');
        }
    });
}
        
        async function deleteProgram(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o n√†y?')) return;
            
            const result = await apiRequest(`/programs/${id}`, {
                method: 'DELETE'
            });
            
            if (result?.success) {
                showToast('ƒê√£ x√≥a CTƒêT th√†nh c√¥ng', 'success');
                if ($.fn.DataTable.isDataTable('#programsTable')) {
                    $('#programsTable').DataTable().ajax.reload();
                }
            } else {
                showToast(result?.message || 'L·ªói khi x√≥a CTƒêT', 'error');
            }
        }
        
async function viewProgramDetail(id) {
    console.log('üîµ [FRONTEND] Viewing program detail ID:', id);
    
    const result = await apiRequest(`/programs/${id}`);
    console.log('üîµ [FRONTEND] API Response:', result);
    
    if (!result?.success) {
        showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin chi ti·∫øt: ' + (result?.message || 'L·ªói server'), 'error');
        return;
    }
    
    const program = result.data;
    const statusText = {
        'draft': { class: 'badge-draft', text: 'Nh√°p' },
        'pending': { class: 'badge-pending', text: 'Ch·ªù duy·ªát' },
        'approved': { class: 'badge-approved', text: 'ƒê√£ duy·ªát' },
        'inactive': { class: 'badge-inactive', text: 'Ng·ª´ng ho·∫°t ƒë·ªông' }
    }[program.status] || { class: 'badge-secondary', text: program.status };
    
    // Hi·ªÉn th·ªã HTML...
    $('#content').html(`
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-info-circle me-2"></i>Chi ti·∫øt: ${program.program_name}</h3>
            <button class="btn btn-secondary" onclick="loadPrograms()">
                <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Th√¥ng tin chi ti·∫øt Ch∆∞∆°ng tr√¨nh ƒê√†o t·∫°o</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <tr>
                                <th width="30%">M√£ CTƒêT:</th>
                                <td><span class="badge bg-primary">${program.program_code}</span></td>
                            </tr>
                            <tr>
                                <th>T√™n CTƒêT:</th>
                                <td><strong>${program.program_name}</strong></td>
                            </tr>
                            <tr>
                                <th>M√£ ng√†nh:</th>
                                <td>${program.course?.code || '-'}</td>
                            </tr>
                            <tr>
                                <th>T√™n ng√†nh:</th>
                                <td>${program.course?.name || '-'}</td>
                            </tr>
                            <tr>
                                <th>H·ªá ƒë√†o t·∫°o:</th>
                                <td>${program.course?.education_system || '-'}</td>
                            </tr>
                            <tr>
                                <th>Kh√≥a tuy·ªÉn sinh:</th>
                                <td>${program.course?.admission_year ? 'Kh√≥a ' + program.course.admission_year : '-'}</td>
                            </tr>
                            <tr>
                                <th>NƒÉm h·ªçc:</th>
                                <td>${program.academic_year}</td>
                            </tr>
                            <tr>
                                <th>S·ªë h·ªçc k·ª≥:</th>
                                <td>${program.total_semesters} h·ªçc k·ª≥</td>
                            </tr>
                            <tr>
                                <th>S·ªë t√≠n ch·ªâ:</th>
                                <td><span class="badge bg-info">${program.total_credits} t√≠n ch·ªâ</span></td>
                            </tr>
                            <tr>
                                <th>Tr·∫°ng th√°i:</th>
                                <td><span class="badge-status ${statusText.class}">${statusText.text}</span></td>
                            </tr>
                            <tr>
                                <th>M√¥ t·∫£:</th>
                                <td>${program.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</td>
                            </tr>
                            <tr>
                                <th>Ng√†y t·∫°o:</th>
                                <td>${new Date(program.created_at).toLocaleDateString('vi-VN')}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Thao t√°c</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            ${currentUser.role === 'admin' || currentUser.role === 'manager' ? `
                            <button class="btn btn-warning" onclick="showEditProgramForm(${program.id})">
                                <i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a
                            </button>
                            <button class="btn btn-danger" onclick="deleteProgram(${program.id})">
                                <i class="fas fa-trash me-2"></i>X√≥a
                            </button>
                            ` : ''}
                            <button class="btn btn-outline-warning" onclick="exportSingleProgramExcel(${program.id})">
                                <i class="fas fa-file-excel me-2"></i>Xu·∫•t Excel CTƒêT
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0">Th√¥ng tin ng√†nh h·ªçc</h5>
                    </div>
                    <div class="card-body">
                        ${program.course ? `
                        <p><strong>${program.course.code} - ${program.course.name}</strong></p>
                        <p>H·ªá: <span class="badge bg-info">${program.course.education_system}</span></p>
                        <p>Kh√≥a: <span class="badge bg-warning">Kh√≥a ${program.course.admission_year}</span></p>
                        <p>Th·ªùi gian: ${program.course.duration} nƒÉm</p>
                        <p>S·ªë t√≠n ch·ªâ: ${program.course.total_credits}</p>
                        ${program.course.department ? `<p>Khoa: ${program.course.department}</p>` : ''}
                        ` : '<p class="text-muted">Kh√¥ng c√≥ th√¥ng tin ng√†nh h·ªçc</p>'}
                    </div>
                </div>
            </div>
        </div>
    `);
}

async function showEditProgramForm(id) {
    console.log('üîµ [FRONTEND] Editing program ID:', id);
    
    const result = await apiRequest(`/programs/${id}`);
    console.log('üîµ [FRONTEND] API Response for edit:', result);
    
    if (!result?.success) {
        showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin CTƒêT ƒë·ªÉ ch·ªânh s·ª≠a: ' + (result?.message || 'L·ªói server'), 'error');
        return;
    }
    
    const program = result.data;
    
    // Load courses for dropdown
    const coursesRes = await apiRequest('/courses');
    let courseOptions = '';
    
    if (coursesRes?.success && coursesRes.data) {
        coursesRes.data.forEach(course => {
            const selected = course.id === program.course_id ? 'selected' : '';
            courseOptions += `
                <option value="${course.id}" ${selected}>
                    ${course.code} - ${course.name} 
                    (H·ªá: ${course.education_system}, Kh√≥a: ${course.admission_year})
                </option>`;
        });
    }
    
    // Hi·ªÉn th·ªã form ch·ªânh s·ª≠a...
    $('#content').html(`
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a: ${program.program_name}</h3>
            <button class="btn btn-secondary" onclick="loadPrograms()">
                <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
            </button>
        </div>
        
        <div class="card">
            <div class="card-body">
                <form id="editProgramForm">
                    <input type="hidden" id="programId" value="${program.id}">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">M√£ CTƒêT <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editProgramCode" value="${program.program_code}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">T√™n CTƒêT <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editProgramName" value="${program.program_name}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ng√†nh h·ªçc <span class="text-danger">*</span></label>
                            <select class="form-select" id="editProgramCourse" required>
                                ${courseOptions}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">NƒÉm h·ªçc <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editProgramYear" value="${program.academic_year}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">S·ªë h·ªçc k·ª≥</label>
                            <input type="number" class="form-control" id="editProgramSemesters" value="${program.total_semesters}" min="1" max="16">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">S·ªë t√≠n ch·ªâ</label>
                            <input type="number" class="form-control" id="editProgramCredits" value="${program.total_credits}" min="1">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tr·∫°ng th√°i</label>
                            <select class="form-select" id="editProgramStatus">
                                <option value="draft" ${program.status === 'draft' ? 'selected' : ''}>Nh√°p</option>
                                <option value="pending" ${program.status === 'pending' ? 'selected' : ''}>Ch·ªù duy·ªát</option>
                                <option value="approved" ${program.status === 'approved' ? 'selected' : ''}>ƒê√£ duy·ªát</option>
                                <option value="inactive" ${program.status === 'inactive' ? 'selected' : ''}>Ng·ª´ng ho·∫°t ƒë·ªông</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">M√¥ t·∫£ chi ti·∫øt</label>
                        <textarea class="form-control" id="editProgramDescription" rows="4">${program.description || ''}</textarea>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-3" onclick="loadPrograms()">H·ªßy</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-sync-alt me-2"></i>C·∫≠p nh·∫≠t
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `);
    
    $('#editProgramForm').submit(async function(e) {
        e.preventDefault();
        
        const programData = {
            program_code: $('#editProgramCode').val(),
            program_name: $('#editProgramName').val(),
            course_id: $('#editProgramCourse').val(),
            academic_year: $('#editProgramYear').val(),
            total_semesters: parseInt($('#editProgramSemesters').val()) || 8,
            total_credits: parseInt($('#editProgramCredits').val()) || 120,
            description: $('#editProgramDescription').val(),
            status: $('#editProgramStatus').val()
        };
        
        const result = await apiRequest(`/programs/${program.id}`, {
            method: 'PUT',
            body: JSON.stringify(programData)
        });
        
        if (result?.success) {
            showToast('C·∫≠p nh·∫≠t CTƒêT th√†nh c√¥ng!', 'success');
            setTimeout(() => loadPrograms(), 1000);
        } else {
            showToast(result?.message || 'L·ªói khi c·∫≠p nh·∫≠t CTƒêT', 'error');
        }
    });
}
        
        async function exportProgramsExcel() {
    console.log('üîµ [FRONTEND] Exporting programs Excel...');
    
    try {
        // Hi·ªÉn th·ªã loading
        const originalTitle = document.title;
        document.title = 'ƒêang xu·∫•t Excel...';
        
        // T·∫°o URL ƒë·∫ßy ƒë·ªß
        const url = 'https://ctdt-manager-backend.onrender.com/api/programs/export/excel';
        const token = localStorage.getItem('token');
        
        console.log('üîµ [FRONTEND] Fetching from:', url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        console.log('üîµ [FRONTEND] Response status:', response.status);
        console.log('üîµ [FRONTEND] Response headers:', Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
            // N·∫øu kh√¥ng ph·∫£i file Excel, th·ª≠ ƒë·ªçc JSON error
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Server error: ${response.status}`);
            } else {
                const text = await response.text();
                console.error('üîµ [FRONTEND] Non-JSON response:', text.substring(0, 200));
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
        }
        
        // Ki·ªÉm tra content-type
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('spreadsheetml')) {
            console.warn('‚ö†Ô∏è [FRONTEND] Unexpected content type:', contentType);
        }
        
        const blob = await response.blob();
        console.log('üîµ [FRONTEND] Blob size:', blob.size, 'bytes');
        
        if (blob.size === 0) {
            throw new Error('File Excel r·ªóng');
        }
        
        const urlObject = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = urlObject;
        a.download = 'danh-sach-chuong-trinh-dao-tao.xlsx';
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        setTimeout(() => {
            window.URL.revokeObjectURL(urlObject);
            document.body.removeChild(a);
            document.title = originalTitle;
        }, 100);
        
        showToast('Xu·∫•t Excel CTƒêT th√†nh c√¥ng!', 'success');
        
    } catch (error) {
        console.error('‚ùå [FRONTEND] Export error:', error);
        showToast(`L·ªói xu·∫•t Excel: ${error.message}`, 'error');
        
        // Th·ª≠ fallback method
        fallbackExportProgramsExcel();
    }
}

// Fallback method: M·ªü trong tab m·ªõi
function fallbackExportProgramsExcel() {
    console.log('üîÑ [FRONTEND] Trying fallback export...');
    
    const token = localStorage.getItem('token');
    const url = `https://ctdt-manager-backend.onrender.com/api/programs/export/excel?token=${encodeURIComponent(token)}`;
    
    // M·ªü trong tab m·ªõi
    const newWindow = window.open(url, '_blank');
    
    if (!newWindow) {
        showToast('Vui l√≤ng cho ph√©p popup ƒë·ªÉ t·∫£i file', 'warning');
        
        // Ho·∫∑c redirect
        setTimeout(() => {
            window.location.href = url;
        }, 1000);
    }
}
        
        // ==================== SEARCH FUNCTIONS ====================
function searchCourses() {
    const searchText = $('#searchCourse').val();
    const educationSystem = $('#filterCourseEducationSystem').val();
    
    let url = 'https://ctdt-manager-backend.onrender.com/api/courses';
    const params = [];
    
    if (searchText) params.push(`search=${encodeURIComponent(searchText)}`);
    if (educationSystem) params.push(`type=${encodeURIComponent(educationSystem)}`);
    
    if (params.length > 0) {
        url += '?' + params.join('&');
    }
    
    // Reload DataTable v·ªõi tham s·ªë t√¨m ki·∫øm
    if ($.fn.DataTable.isDataTable('#coursesTable')) {
        const table = $('#coursesTable').DataTable();
        table.ajax.url(url).load();
        showToast(`ƒê√£ t√¨m ki·∫øm: ${searchText || 't·∫•t c·∫£'}`, 'info');
    }
}

function resetCourseSearch() {
    $('#searchCourse').val('');
    $('#filterCourseType').val('');
    
    if ($.fn.DataTable.isDataTable('#coursesTable')) {
        const table = $('#coursesTable').DataTable();
        table.ajax.url('https://ctdt-manager-backend.onrender.com/api/courses').load();
    }
    
    showToast('ƒê√£ ƒë·∫∑t l·∫°i t√¨m ki·∫øm', 'info');
}

function searchPrograms() {
    const searchText = $('#searchProgram').val();
    const status = $('#filterProgramStatus').val();
    const courseId = $('#filterProgramCourse').val();
    
    let url = 'https://ctdt-manager-backend.onrender.com/api/programs';
    const params = [];
    
    if (searchText) params.push(`search=${encodeURIComponent(searchText)}`);
    if (status) params.push(`status=${encodeURIComponent(status)}`);
    if (courseId) params.push(`course_id=${encodeURIComponent(courseId)}`);
    
    if (params.length > 0) {
        url += '?' + params.join('&');
    }
    
    // Reload DataTable v·ªõi tham s·ªë t√¨m ki·∫øm
    if ($.fn.DataTable.isDataTable('#programsTable')) {
        const table = $('#programsTable').DataTable();
        table.ajax.url(url).load();
        showToast(`ƒê√£ t√¨m ki·∫øm ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o`, 'info');
    }
}

function loadProgramsByCourse(courseId) {
    // ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn trang qu·∫£n l√Ω CTƒêT v√† l·ªçc theo course_id
    loadPrograms();
    
    // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ table ƒë∆∞·ª£c kh·ªüi t·∫°o
    setTimeout(() => {
        $('#filterProgramCourse').val(courseId);
        searchPrograms();
    }, 500);
}
// Th√™m s·ª± ki·ªán Enter ƒë·ªÉ t√¨m ki·∫øm
$(document).ready(function() {
    // T√¨m ki·∫øm kh√≥a h·ªçc b·∫±ng Enter
    $('#searchCourse').keypress(function(e) {
        if (e.which === 13) { // Enter key
            searchCourses();
            return false;
        }
    });
    
    // T√¨m ki·∫øm CTƒêT b·∫±ng Enter
    $('#searchProgram').keypress(function(e) {
        if (e.which === 13) { // Enter key
            searchPrograms();
            return false;
        }
    });
});
        // ==================== HELPER FUNCTIONS ====================
        function updateActiveMenu() {
            $('.nav-link').removeClass('active');
            $(`.nav-link:contains("${currentPage === 'dashboard' ? 'Dashboard' : currentPage === 'courses' ? 'Kh√≥a/H·ªá/Ng√†nh' : 'CTƒêT'}")`).addClass('active');
        }
        
        function showProfile() {
            $('#content').html(`
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-user me-2"></i>T√†i kho·∫£n c·ªßa t√¥i</h3>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-user-circle fa-4x text-primary mb-3"></i>
                                <h4>${currentUser.full_name || currentUser.username}</h4>
                                <p class="text-muted">${currentUser.role === 'admin' ? 'Qu·∫£n tr·ªã vi√™n' : currentUser.role === 'manager' ? 'Qu·∫£n l√Ω' : 'Ng∆∞·ªùi d√πng'}</p>
                                <p><i class="fas fa-envelope me-2"></i>${currentUser.email}</p>
                                ${currentUser.department ? `<p><i class="fas fa-building me-2"></i>${currentUser.department}</p>` : ''}
                                ${currentUser.phone ? `<p><i class="fas fa-phone me-2"></i>${currentUser.phone}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Th√¥ng tin h·ªá th·ªëng</h5>
                            </div>
                            <div class="card-body">
                                <p>H·ªá th·ªëng Qu·∫£n l√Ω ƒê√†o t·∫°o ƒê·∫°i h·ªçc</p>
                                <p>Phi√™n b·∫£n: 1.0.0</p>
                                <p>ƒêƒÉng nh·∫≠p l√∫c: ${new Date().toLocaleString('vi-VN')}</p>
                                <hr>
                                <button class="btn btn-outline-primary me-2" onclick="showDashboard()">
                                    <i class="fas fa-home me-2"></i>V·ªÅ trang ch·ªß
                                </button>
                                <button class="btn btn-outline-danger" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
        }
        
        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }
    </script>
</body>

</html>


